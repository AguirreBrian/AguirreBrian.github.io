<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Cuentas - Licencias Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "mcm-blue": "#1a73e8",
              "mcm-green": "#009944", // Color para el botón de Licencias
              "mcm-red": "#dc2626", // Color para el botón de Números
              "mcm-light-blue": "#e8f0fe", // Para fondos suaves
              "mcm-dark-green": "#007a33",
              "mcm-yellow": "#f59e0b", // Color para Cuarentena
            },
          },
        },
      };
    </script>
    <style>
      .action-button {
        @apply p-1 rounded-full w-8 h-8 flex items-center justify-center transition duration-150 ease-in-out;
      }

      .form-input {
        @apply block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-mcm-blue focus:border-mcm-blue sm:text-sm transition duration-150;
      }
      .form-label {
        @apply block text-xs font-bold text-gray-900 mb-1;
      }

      .modal-active {
        overflow: hidden !important;
      }

      .modal {
        @apply fixed inset-0 bg-gray-900 bg-opacity-85 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300 ease-out p-4;
      }

      .modal-content {
        @apply bg-white rounded-xl shadow-2xl w-full max-w-6xl transform transition-transform duration-300 ease-out max-h-[90vh] flex flex-col; /* max-h-[90vh] limita la altura, flex-col para organizar bien el scroll */
      }

      .read-only-text {
        @apply block w-full px-4 py-2 text-gray-800 bg-gray-100 border border-gray-200 rounded-lg sm:text-sm font-medium truncate;
      }

      .number-list-item {
        @apply bg-white rounded-xl shadow-md mb-3 p-3 transition duration-150 ease-in-out border border-gray-200;
        position: relative;
        @apply flex justify-between items-center;
        padding-left: 1.25rem;
      }
      .number-list-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0.5rem; /* Ancho de la barra */
        background-color: transparent;
        border-top-left-radius: 0.75rem;
        border-bottom-left-radius: 0.75rem;
        transition: background-color 0.15s ease-in-out;
      }

      .number-list-item:hover {
        @apply shadow-lg border-mcm-blue/50;
      }

      .number-list-selected {
        @apply border-mcm-blue shadow-lg;
      }
      .number-list-selected::before {
        background-color: #a8dadc; /* Un color aqua claro para selección */
      }

      /* Estilo para el Main Number (DESTACADO) */
      .is-main-number {
        /* Aplicar el estilo fuerte (Main Number debe ser el azul fuerte y barra fuerte) */
        @apply bg-mcm-light-blue border-mcm-blue;
      }
      .is-main-number::before {
        background-color: #1a73e8 !important; /* mcm-blue fuerte */
      }

      /* Estilo para la etiqueta Main Number (Nueva Clase) */
      .badge-main-number {
        /* Etiqueta que va a la derecha del número */
        @apply ml-3 px-2 py-0.5 bg-mcm-blue text-white text-xs font-bold rounded-full shadow-sm;
      }

      /* Estilos para el separador de Portabilidades (similar a la imagen) */
      .portability-divider {
        @apply w-full flex justify-center py-6;
      }
      .portability-divider::before {
        content: "";
        @apply w-1/2 h-px bg-gray-300 absolute top-1/2 transform -translate-y-1/2;
      }
      .portability-divider span {
        @apply relative bg-white px-3 text-mcm-blue;
      }

      /* Estilo para el input de archivo (oculto) */
      .file-input-wrapper {
        @apply relative flex items-center justify-between h-10;
      }
      .file-input-wrapper input[type="file"] {
        /* Ocultar el input real */
        @apply absolute inset-0 opacity-0 cursor-pointer w-full h-full;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans min-h-screen">
    <!-- 1. Barra de Navegación Superior (Header) -->
    <header class="bg-white shadow-lg fixed w-full z-10">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between"
      >
        <!-- Logo MCM y Título -->
        <div class="flex items-center space-x-4">
          <div class="text-xl font-extrabold text-mcm-blue">MCM</div>
          <div
            class="text-xl text-gray-800 font-semibold border-l pl-4 hidden sm:block"
          >
            Licencias Cloud
          </div>
        </div>

        <!-- Administrador Dropdown -->
        <div
          class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition"
        >
          <span class="text-sm font-medium text-gray-700 hidden sm:inline"
            >Administrador</span
          >
          <svg
            class="w-5 h-5 text-gray-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </div>
      </div>
    </header>

    <!-- 2. Contenido Principal SIN Sidebar -->
    <div class="pt-16 flex justify-center">
      <!-- Área de Contenido Principal -->
      <main class="flex-1 p-4 sm:p-8 lg:p-12 max-w-7xl w-full">
        <!-- Contenedor Principal de la Aplicación -->
        <div class="bg-white shadow-2xl rounded-xl p-4 sm:p-6 lg:p-8 w-full">
          <!-- 3. Navegación por Pestañas -->
          <nav class="border-b mb-6">
            <div
              class="flex space-x-6 sm:space-x-8 -mb-px text-sm font-medium text-gray-500"
            >
              <!-- Pestaña Activa -->
              <a
                href="#"
                id="tab-cuentas"
                data-view="cuentas"
                class="py-2 border-b-2 transition"
                >Cuentas</a
              >
              <a
                href="#"
                id="tab-numeros"
                data-view="numeros"
                class="py-2 border-b-2 transition"
                >Números</a
              >
              <a
                href="#"
                id="tab-portabilidades"
                data-view="portabilidades"
                class="py-2 border-b-2 transition"
                >Portabilidades</a
              >
            </div>
          </nav>

          <!-- CONTENEDOR DE VISTAS -->
          <div id="view-container">
            <!-- VISTA 1: CUENTAS -->
            <div id="view-cuentas">
              <!-- 4. Gestión de Cuentas (Título y Botón de Acción) -->
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-mcm-blue/50"
              >
                <h2 class="text-2xl font-light text-gray-800 mb-4 sm:mb-0">
                  Gestión de Cuentas
                </h2>
                <!-- Botón Agregar Cuenta (Alineado a la derecha) -->
                <button
                  id="openModalBtn"
                  class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out uppercase text-sm flex items-center space-x-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <span>Agregar Cuenta</span>
                </button>
              </div>

              <!-- 5. Título y Toggle de Filtros de Cuentas -->
              <div class="flex justify-between items-center mb-4">
                <p class="text-sm font-semibold text-gray-600 uppercase">
                  Opciones de Filtrado de Cuentas
                </p>
                <button
                  id="toggleFiltersBtn"
                  class="p-2 text-mcm-blue hover:text-blue-700 transition"
                >
                  <svg
                    id="filterIcon"
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 transform rotate-0 transition duration-300"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <!-- Icono de flecha hacia arriba (ocultar) -->
                    <path
                      fill-rule="evenodd"
                      d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>

              <!-- Barra de Filtros de Cuentas -->
              <div
                id="filterBar"
                class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 border border-gray-200 transition-all duration-300 overflow-hidden"
              >
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <!-- Filtro ID RingCentral -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterId"
                      >ID RingCentral</label
                    >
                    <input
                      id="filterId"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por ID"
                    />
                  </div>

                  <!-- Filtro Tenant -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterTenant">Tenant</label>
                    <input
                      id="filterTenant"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por Tenant"
                    />
                  </div>

                  <!-- Filtro Oportunidad -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterOpp"
                      >Oportunidad</label
                    >
                    <input
                      id="filterOpp"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por Oportunidad"
                    />
                  </div>

                  <!-- Botones de Acción (Buscar y Limpiar) -->
                  <div
                    class="flex flex-col space-y-2 pt-2 md:pt-0 md:space-y-0 md:flex-row md:space-x-2 items-end"
                  >
                    <!-- NUEVO Botón de Búsqueda -->
                    <button
                      id="searchFiltersBtn"
                      class="w-full md:w-1/2 bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition duration-150 uppercase text-sm flex items-center justify-center space-x-2 h-10"
                    >
                      <span>Buscar</span>
                    </button>

                    <!-- Botón de Limpiar Filtros (Refresh Icon) -->
                    <button
                      id="clearFiltersBtn"
                      class="w-full md:w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-sm transition duration-150 uppercase text-sm flex items-center justify-center space-x-2 h-10"
                    >
                      <span>Limpiar</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- 6. Tabla de Datos de Cuentas -->
              <div
                class="overflow-x-auto shadow-lg rounded-lg border border-gray-200"
              >
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-100">
                    <tr>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]"
                      >
                        ID RING CENTRAL
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[40%]"
                      >
                        TENANT
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]"
                      >
                        Oportunidad
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-[30%]"
                      >
                        ACCIONES
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="accountsTable"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Las filas se inyectan aquí mediante JS -->
                  </tbody>
                </table>

                <!-- 7. Paginación Mejorada de Cuentas -->
                <div
                  class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 border-t border-gray-200 space-y-3 sm:space-y-0"
                >
                  <!-- Selector de Tamaño de Página -->
                  <div class="flex items-center space-x-2">
                    <label
                      for="pageSize"
                      class="text-sm text-gray-600 font-medium"
                      >Registros por página:</label
                    >
                    <select id="pageSize" class="form-input w-20 py-1 px-2">
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                    </select>
                  </div>

                  <!-- Información de Página y Navegación -->
                  <div class="flex items-center space-x-4">
                    <span
                      id="pageInfo"
                      class="text-sm font-medium text-gray-700 whitespace-nowrap"
                    ></span>

                    <div class="flex space-x-2">
                      <button
                        id="prevPage"
                        class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-mcm-light-blue hover:border-mcm-blue disabled:opacity-50 disabled:cursor-not-allowed transition duration-150"
                      >
                        <!-- Icono Flecha Izquierda -->
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"
                          />
                        </svg>
                      </button>

                      <button
                        id="nextPage"
                        class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-mcm-light-blue hover:border-mcm-blue disabled:opacity-50 disabled:cursor-not-allowed transition duration-150"
                      >
                        <!-- Icono Flecha Derecha -->
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- VISTA 2: NÚMEROS -->
            <div id="view-numeros" class="hidden">
              <!-- 4. Gestión de Números (Título y Botón de Acción) -->
              <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-mcm-blue/50"
              >
                <h2 class="text-2xl font-light text-gray-800 mb-4 sm:mb-0">
                  Inventario y Gestión de Números
                </h2>
                <!-- Botón Actualizar Números -->
                <button
                  id="updateNumbersBtn"
                  class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out uppercase text-sm flex items-center space-x-2"
                >
                  <span>Importar Números</span>
                </button>
              </div>

              <!-- 5. Título y Toggle de Filtros de Números -->
              <div class="flex justify-between items-center mb-4">
                <p class="text-sm font-semibold text-gray-600 uppercase">
                  Opciones de Filtrado de Números
                </p>
                <button
                  id="toggleNumbersFiltersBtn"
                  class="p-2 text-mcm-blue hover:text-blue-700 transition"
                >
                  <svg
                    id="numbersFilterIcon"
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 transform rotate-0 transition duration-300"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
              </div>

              <!-- Barra de Filtros de Números -->
              <div
                id="numbersFilterBar"
                class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 border border-gray-200 transition-all duration-300 overflow-hidden"
              >
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <!-- Filtro Número -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterNumber">Número</label>
                    <input
                      id="filterNumber"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por número"
                    />
                  </div>

                  <!-- Filtro Tenant -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterNumberTenant"
                      >Tenant</label
                    >
                    <input
                      id="filterNumberTenant"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por Tenant"
                    />
                  </div>

                  <!-- Filtro Estatus -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterStatus">Estatus</label>
                    <select id="filterStatus" class="form-input">
                      <option value="">Todos</option>
                      <option value="Disponible">Disponible</option>
                      <option value="Asignado">Asignado</option>
                    </select>
                  </div>

                  <!-- Filtro Portabilidad -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterPorta"
                      >Portabilidad</label
                    >
                    <select id="filterPorta" class="form-input">
                      <option value="">Todos</option>
                      <option value="Disponible">Propiedad MCM</option>
                      <option value="Asignado">Alta</option>
                      <option value="Asignado">Baja</option>
                    </select>
                  </div>

                  <!-- Filtro Cuarentena -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterQuarantine"
                      >Cuarentena</label
                    >
                    <select id="filterQuarantine" class="form-input">
                      <option value="">Todos</option>
                      <option value="Si">Sí</option>
                      <option value="No">No</option>
                    </select>
                  </div>

                  <!-- Filtro ID Ring Central -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterRCID"
                      >ID Ring Central</label
                    >
                    <input
                      id="filterRCID"
                      type="text"
                      class="form-input"
                      placeholder="Buscar por RC ID"
                    />
                  </div>
                  <!-- Filtro Dias Cuarentena -->
                  <div class="flex flex-col space-y-1">
                    <label class="form-label" for="filterQuarantineDays"
                      >Días Restantes</label
                    >
                    <input
                      id="filterQuarantineDays"
                      type="text"
                      class="form-input"
                      placeholder="Ej: 5"
                    />
                  </div>
                  <!-- Botones de Acción (Buscar y Limpiar) -->
                  <div class="md:col-span-5 flex justify-end space-x-2 pt-2">
                    <!-- NUEVO Botón de Búsqueda -->
                    <button
                      id="searchNumbersFiltersBtn"
                      class="w-32 bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition duration-150 uppercase text-sm flex items-center justify-center space-x-2 h-10"
                    >
                      <span>Buscar</span>
                    </button>

                    <!-- Botón de Limpiar Filtros (Refresh Icon) -->
                    <button
                      id="clearNumbersFiltersBtn"
                      class="w-32 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-sm transition duration-150 uppercase text-sm flex items-center justify-center space-x-2 h-10"
                    >
                      <span>Limpiar</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Tabla de Números -->
              <div
                class="overflow-x-auto shadow-lg rounded-lg border border-gray-200"
              >
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-100">
                    <tr>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[20%]"
                      >
                        Número
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]"
                      >
                        Estatus
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]"
                      >
                        Cuarentena
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                      >
                        Días Rest.
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[25%]"
                      >
                        Tenant
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[25%]"
                      >
                        ID Ring Central
                      </th>
                      <th
                        scope="col"
                        class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[25%]"
                      >
                        Portabilidad
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="numbersTable"
                    class="bg-white divide-y divide-gray-200"
                  >
                    <!-- Las filas se inyectan aquí mediante JS -->
                    <tr>
                      <td colspan="5" class="py-10 text-center text-gray-500">
                        Cargando números...
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Paginación de Números -->
                <div
                  class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 border-t border-gray-200 space-y-3 sm:space-y-0"
                >
                  <div class="flex items-center space-x-2">
                    <label
                      for="numbersPageSize"
                      class="text-sm text-gray-600 font-medium"
                      >Registros por página:</label
                    >
                    <select
                      id="numbersPageSize"
                      class="form-input w-20 py-1 px-2"
                    >
                      <option value="5">5</option>
                      <option value="10" selected>10</option>
                      <option value="20">20</option>
                      <option value="50">50</option>
                    </select>
                  </div>

                  <div class="flex items-center space-x-4">
                    <span
                      id="numbersPageInfo"
                      class="text-sm font-medium text-gray-700 whitespace-nowrap"
                    ></span>

                    <div class="flex space-x-2">
                      <button
                        id="numbersPrevPage"
                        class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-mcm-light-blue hover:border-mcm-blue disabled:opacity-50 disabled:cursor-not-allowed transition duration-150"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"
                          />
                        </svg>
                      </button>

                      <button
                        id="numbersNextPage"
                        class="px-3 py-1 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-mcm-light-blue hover:border-mcm-blue disabled:opacity-50 disabled:cursor-not-allowed transition duration-150"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-4 w-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- VISTA 3: PORTABILIDADES (ACTUALIZADA: CON FILTROS Y PAGINACIÓN) -->
            <div id="view-portabilidades" class="hidden">
              <div
                class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-mcm-blue mb-8"
              >
                <div class="flex flex-col md:flex-row md:items-end gap-4">
                  <div class="w-full md:w-1/2">
                    <label
                      for="superFilterTenant"
                      class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide"
                    >
                      1. Seleccione Cliente (Tenant)
                    </label>
                    <div class="relative">
                      <select
                        id="superFilterTenant"
                        class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-mcm-blue focus:border-mcm-blue sm:text-sm rounded-md shadow-sm bg-gray-50 hover:bg-white transition-colors cursor-pointer"
                      >
                        <option value="">
                          -- Seleccione un Cliente para comenzar --
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="pb-2 text-sm text-gray-500 italic">
                    * Seleccione un cliente para habilitar la gestión y filtros.
                  </div>
                </div>
              </div>

              <div
                id="mainPortabilityContainer"
                class="opacity-50 pointer-events-none transition-opacity duration-300"
              >
                <div
                  class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-mcm-blue/50"
                >
                  <h2 class="text-2xl font-light text-gray-800 mb-4 sm:mb-0">
                    Gestión de Portabilidades
                    <span
                      id="selectedClientTitle"
                      class="font-bold text-mcm-blue text-lg ml-2"
                    ></span>
                  </h2>
                  <button
                    id="openPortabilityModalBtn"
                    disabled
                    class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out uppercase text-sm flex items-center space-x-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 4v16m8-8H4"
                      />
                    </svg>
                    <span>Agregar números portados</span>
                  </button>
                </div>

                <div class="flex justify-between items-center mb-4">
                  <p class="text-sm font-semibold text-gray-600 uppercase">
                    Filtros Avanzados (Sobre el cliente seleccionado)
                  </p>
                  <button
                    id="togglePortabilityFiltersBtn"
                    class="p-2 text-mcm-blue hover:text-blue-700 transition"
                  >
                    <svg
                      id="portabilityFilterIcon"
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 transform rotate-0 transition duration-300"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>

                <div
                  id="portabilityFilterBar"
                  class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 border border-gray-200 transition-all duration-300 overflow-hidden"
                >
                  <div
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"
                  >
                    <div class="flex flex-col space-y-1">
                      <label class="form-label" for="filterPortId"
                        >ID Portabilidad</label
                      >
                      <input
                        id="filterPortId"
                        type="text"
                        class="form-input"
                        placeholder="Ej: PORT-001"
                      />
                    </div>

                    <div class="flex flex-col space-y-1">
                      <label class="form-label" for="filterPortType"
                        >Tipo Portabilidad</label
                      >
                      <select id="filterPortType" class="form-input">
                        <option value="">Todos</option>
                        <option value="1">Alta (MCM Receptor)</option>
                        <option value="0">Baja (MCM Donador)</option>
                      </select>
                    </div>

                    <div class="flex flex-col space-y-1">
                      <label class="form-label" for="filterPortDateStart"
                        >Fecha (Inicio)</label
                      >
                      <input
                        id="filterPortDateStart"
                        type="date"
                        class="form-input"
                      />
                    </div>

                    <div class="flex flex-col space-y-1">
                      <label class="form-label" for="filterPortDateEnd"
                        >Fecha (Fin)</label
                      >
                      <input
                        id="filterPortDateEnd"
                        type="date"
                        class="form-input"
                      />
                    </div>

                    <div
                      class="md:col-span-4 flex justify-end space-x-2 pt-2 border-t border-gray-200 mt-2"
                    >
                      <button
                        id="searchPortabilityFiltersBtn"
                        class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm text-sm uppercase"
                      >
                        Filtrar
                      </button>
                      <button
                        id="clearPortabilityFiltersBtn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg shadow-sm text-sm uppercase"
                      >
                        Limpiar Filtros
                      </button>
                    </div>
                  </div>
                </div>

                <div
                  class="p-4 border border-gray-200 rounded-xl shadow-lg bg-white"
                >
                  <h3
                    class="text-lg font-semibold text-gray-700 mb-4 border-l-4 border-mcm-blue pl-3"
                  >
                    Registro de Portabilidades
                  </h3>
                  <div
                    class="overflow-x-auto shadow-lg rounded-lg border border-gray-200"
                  >
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-100">
                        <tr>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[5%]"
                          >
                            ID
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                          >
                            PortID
                          </th>
                          <th
                            class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-[8%]"
                          >
                            Total DIDs
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]"
                          >
                            Tenant
                          </th>
                          <th
                            class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                          >
                            Tipo
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[12%]"
                          >
                            F. Solicitud
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[12%]"
                          >
                            F. Ejecución
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[12%]"
                          >
                            Tipo Núm
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                          >
                            Donador
                          </th>
                          <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                          >
                            Receptor
                          </th>
                          <th
                            class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-[10%]"
                          >
                            Acciones
                          </th>
                        </tr>
                      </thead>
                      <tbody
                        id="portabilityRegisterTable"
                        class="bg-white divide-y divide-gray-200"
                      >
                        <tr>
                          <td
                            colspan="9"
                            class="p-8 text-center text-gray-400 italic"
                          >
                            Seleccione un cliente en el filtro superior para ver
                            los registros.
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div
                    class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 border-t border-gray-200 mt-4 space-y-3 sm:space-y-0 rounded-b-lg"
                  >
                    <div class="flex items-center space-x-2">
                      <label
                        for="portabilityPageSize"
                        class="text-sm text-gray-600 font-medium"
                        >Registros por pág:</label
                      >
                      <select
                        id="portabilityPageSize"
                        class="form-input w-20 py-1 px-2 border-gray-300 rounded"
                      >
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                      </select>
                    </div>
                    <div class="flex items-center space-x-4">
                      <span
                        id="portabilityPageInfo"
                        class="text-sm font-medium text-gray-700 whitespace-nowrap"
                      ></span>
                      <div class="flex space-x-2">
                        <button
                          id="portabilityPrevPage"
                          class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-blue-50"
                        >
                          Ant
                        </button>
                        <button
                          id="portabilityNextPage"
                          class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-blue-50"
                        >
                          Sig
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fin: view-container -->
        </div>

        <!-- Simulando el contenedor más grande y el footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
          <!-- Espacio para el pie de página o margen inferior del contenedor principal -->
        </div>
      </main>
    </div>

    <!-- Modal 1: Agregar Cuenta (REDISEÑADO) -->
    <div
      id="accountModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO -->
        <div class="flex justify-between items-center p-6 border-b bg-white">
          <h3 class="text-xl font-semibold text-gray-800">
            Agregar Nueva Cuenta
          </h3>
          <button
            id="closeModalBtn"
            class="text-gray-400 hover:text-gray-600 transition duration-150"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- CUERPO SCROLLEABLE -->
        <div class="overflow-y-auto p-6 space-y-6">
          <!-- SECCIÓN 1: OPORTUNIDAD (Mantiene la funcionalidad de búsqueda) -->
          <div class="border p-4 rounded-xl bg-gray-50 shadow-inner">
            <div
              class="flex flex-col sm:flex-row justify-between border-b pb-3 mb-4 sm:items-center"
            >
              <h4 class="text-lg font-semibold text-gray-700 flex items-center">
                Buscar oportunidad
              </h4>
              <button
                id="searchOpportunityBtn"
                class="mt-2 sm:mt-0 bg-mcm-blue hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow text-sm transition"
              >
                BUSCAR OP
              </button>
            </div>

            <label class="form-label">Oportunidad ID:</label>
            <input
              type="text"
              id="op_id"
              class="form-input"
              placeholder="Ej: 123456 (Usar 123456 o 654321 para probar)"
              value="123456"
            />
          </div>

          <!-- SECCIÓN 2: DATOS CARGADOS (Diseño de Tarjetas) -->
          <!-- Usamos grid-cols-1 md:grid-cols-2 para el layout principal de los datos -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Columna 1: Datos Cliente (Tarjeta de Presentación) -->
            <div
              id="clientDataContainer"
              class="border p-5 rounded-xl shadow-lg bg-white"
            >
              <h4
                class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center"
              >
                Datos cliente
              </h4>

              <div class="space-y-3">
                <!-- NAME (TENANT) -->
                <div>
                  <label class="form-label">Nombre (Tenant):</label>
                  <div id="client_name_display" class="read-only-text">N/A</div>
                </div>

                <!-- Grid de dirección - 5 columnas para mejor uso del espacio -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="form-label">Calle:</label>
                    <div id="client_street_display" class="read-only-text">
                      N/A
                    </div>
                  </div>
                  <div>
                    <label class="form-label">Colonia:</label>
                    <div id="client_colony_display" class="read-only-text">
                      N/A
                    </div>
                  </div>
                </div>
                <div
                  class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"
                >
                  <div>
                    <label class="form-label">Ciudad:</label>
                    <div id="client_city_display" class="read-only-text">
                      N/A
                    </div>
                  </div>
                  <div>
                    <label class="form-label">Estado:</label>
                    <div id="client_state_display" class="read-only-text">
                      N/A
                    </div>
                  </div>
                  <div>
                    <label class="form-label">País:</label>
                    <div id="client_country_display" class="read-only-text">
                      N/A
                    </div>
                  </div>
                </div>

                <!-- CP -->
                <div class="max-w-xs">
                  <label class="form-label">CP:</label>
                  <div id="client_zip_display" class="read-only-text">N/A</div>
                </div>
              </div>
            </div>

            <!-- Columna 2: Datos PM (Tarjeta de Presentación) -->
            <div class="border p-5 rounded-xl shadow-lg bg-white">
              <h4
                class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center"
              >
                Datos PM
              </h4>

              <div class="space-y-3">
                <!-- OT (INPUT ACTIVO) -->
                <div>
                  <label class="form-label">OT:</label>
                  <select id="pm_ot" class="form-input">
                    <option value="" selected>Seleccione una OT</option>
                    <option value="OT 1">OT 1</option>
                    <option value="OT 2">OT 2</option>
                  </select>
                </div>

                <!-- PM RESPONSABLE -->
                <div>
                  <label class="form-label">PM Responsable:</label>
                  <div id="pm_responsible_display" class="read-only-text">
                    N/A
                  </div>
                </div>

                <!-- EMAIL MEGA -->
                <div>
                  <label class="form-label">Email Mega:</label>
                  <div id="pm_email_display" class="read-only-text">N/A</div>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 3: LICENCIAMIENTO (Condicional) -->
          <div
            id="licensingSection"
            class="border p-4 rounded-xl bg-gray-50 shadow-inner hidden"
          >
            <h4 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">
              Licenciamiento
            </h4>

            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="licensingTableContainer"
            >
              <p class="p-4 text-gray-500 text-center">
                Seleccione una OT para cargar las licencias de la oportunidad.
              </p>
            </div>
          </div>
        </div>

        <!-- FOOTER FIJO -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <button
            id="cancelModalBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Cancelar
          </button>

          <button
            class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm"
          >
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal 2: Vista de Detalles de Cuenta -->
    <div
      id="viewDetailsModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO (AHORA CON NOMBRE GRANDE) -->
        <div class="p-6 border-b bg-white">
          <div class="flex justify-between items-start">
            <!-- Título Principal (Nombre del Cliente/Tenant) -->
            <div class="flex flex-col">
              <h3
                class="text-2xl font-bold text-gray-800 mb-1"
                id="view-header-client-name"
              >
                Cargando Nombre...
              </h3>
              <!-- ID RingCentral -->
              <p class="text-sm font-medium text-gray-500">
                ID Ring Central: <span id="view-header-rcid">...</span>
              </p>
            </div>
            <!-- Botón de Cerrar -->
            <button
              id="closeViewModalBtn"
              class="text-gray-400 hover:text-gray-600 transition duration-150"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- CUERPO SCROLLEABLE (Read-Only - Estilizado con Tarjetas) -->
        <div class="overflow-y-auto p-6 space-y-6">
          <!-- SECCIÓN DE OPORTUNIDAD (Pequeño Card de arriba) -->
          <div class="border p-4 rounded-xl bg-gray-50 shadow-inner">
            <h4
              class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4 flex items-center"
            >
              Oportunidad
            </h4>

            <div class="space-y-2">
              <div>
                <label class="form-label">Oportunidad ID:</label>
                <div id="view-op_id" class="read-only-text"></div>
              </div>
            </div>
          </div>

          <!-- DATOS CLIENTE Y PM EN DOS COLUMNAS -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Columna 1: Datos Cliente -->
            <div class="border p-5 rounded-xl shadow-lg bg-white">
              <h4
                class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center"
              >
                Datos cliente
              </h4>
              <div class="space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="form-label">Calle:</label>
                    <div id="view-client_street" class="read-only-text"></div>
                  </div>
                  <div>
                    <label class="form-label">Colonia:</label>
                    <div id="view-client_colony" class="read-only-text"></div>
                  </div>
                </div>
                <div
                  class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"
                >
                  <div>
                    <label class="form-label">Ciudad:</label>
                    <div id="view-client_city" class="read-only-text"></div>
                  </div>
                  <div>
                    <label class="form-label">Estado:</label>
                    <div id="view-client_state" class="read-only-text"></div>
                  </div>
                  <div>
                    <label class="form-label">País:</label>
                    <div id="view-client_country" class="read-only-text"></div>
                  </div>
                </div>
                <div class="max-w-xs">
                  <label class="form-label">CP:</label>
                  <div id="view-client_zip" class="read-only-text"></div>
                </div>
              </div>
            </div>

            <!-- Columna 2: Datos PM -->
            <div class="border p-5 rounded-xl shadow-lg bg-white">
              <h4
                class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center"
              >
                Datos PM
              </h4>
              <div class="space-y-3">
                <div>
                  <label class="form-label">OT:</label>
                  <div id="view-pm_ot" class="read-only-text"></div>
                </div>
                <div>
                  <label class="form-label">PM Responsable:</label>
                  <div id="view-pm_responsible" class="read-only-text"></div>
                </div>
                <div>
                  <label class="form-label">Email Mega:</label>
                  <div id="view-pm_email" class="read-only-text"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN: NÚMEROS ASIGNADOS -->
          <div class="border p-4 rounded-lg bg-gray-50">
            <h4
              class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4 flex items-center"
            >
              Números Asignados
            </h4>

            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="view-numbers-table-container"
            >
              <!-- La tabla de números se inyectará aquí -->
            </div>
          </div>

          <!-- SECCIÓN: LICENCIAMIENTO (VIEW) -->
          <div class="border p-4 rounded-lg bg-gray-50">
            <h4 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">
              Licenciamiento Asignado
            </h4>

            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="view-licensing-table-container"
            >
              <!-- La tabla de licencias se inyectará aquí -->
            </div>
          </div>
        </div>

        <!-- FOOTER FIJO CON BOTONES DE ACCIÓN -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <!-- Botón de Gestión Licencias -->
          <button
            id="btnGestionLicencias"
            class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Gestión Licencias
          </button>

          <!-- Botón de Gestión Números -->
          <button
            id="btnGestionNumeros"
            class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Gestión Números
          </button>
        </div>
      </div>
    </div>

    <!-- Modal 3: Gestión de Licencias -->
    <div
      id="licenseManagementModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO -->
        <div class="p-6 border-b bg-white">
          <div class="flex justify-between items-start">
            <!-- Título Principal (Nombre del Cliente/Tenant) -->
            <div class="flex flex-col">
              <h3
                class="text-2xl font-bold text-gray-800 mb-1"
                id="manage-header-client-name"
              >
                Gestión de Licencias para: Cargando Nombre...
              </h3>
              <!-- ID RingCentral -->
              <p class="text-sm font-medium text-gray-500">
                ID Ring Central: <span id="manage-header-rcid">...</span>
              </p>
            </div>
            <!-- Botón de Cerrar -->
            <button
              id="closeLicenseModalBtn"
              class="text-gray-400 hover:text-gray-600 transition duration-150"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- CUERPO SCROLLEABLE -->
        <div class="overflow-y-auto p-6 space-y-6">
          <!-- SECCIÓN: LICENCIAS ASIGNADAS (EDITABLE) -->
          <div class="border p-4 rounded-xl bg-gray-50 shadow-inner">
            <h4
              class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4 flex items-center"
            >
              Licencias Asignadas
            </h4>
            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="manage-licensing-table-container"
            >
              <!-- Tabla editable inyectada por JS -->
            </div>
          </div>

          <!-- SECCIÓN: AÑADIR NUEVA LICENCIA -->

          <div class="border p-5 rounded-xl shadow-lg bg-white">
            <h4
              class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2 text-mcm-green"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>

              Nuevo Tipo de Licencia
            </h4>

            <!-- CONTENEDOR DE MENSAJES DE VALIDACIÓN -->

            <div
              id="licenseAddMessage"
              class="mb-4 hidden p-3 rounded-lg text-sm font-medium"
            ></div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="form-label" for="new_product">Licencia</label>
                <select>
                  <option value="10" selected>Seleccionar</option>
                  <option value="20">Estandar</option>
                  <option value="50">Premium</option>
                </select>
              </div>

              <div>
                <label class="form-label" for="new_qty">Cantidad</label>

                <input
                  type="number"
                  id="new_qty"
                  class="form-input"
                  min="1"
                  value="1"
                />
              </div>

              <div class="flex items-end">
                <button
                  id="addNewLicenseBtn"
                  class="w-full bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 uppercase text-sm"
                >
                  Añadir
                </button>
              </div>
            </div>
          </div>
          <!-- Los campos Type, Package, Pkg ID, Lic ID, Subfam se manejarían en un modal/API real -->
        </div>
        <!-- FOOTER FIJO -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <button
            id="cancelLicenseModalBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Cerrar
          </button>

          <button
            id="saveLicenseChangesBtn"
            class="bg-mcm-green hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm"
          >
            Guardar Cambios
          </button>
        </div>
      </div>
    </div>

    <!-- Modal 4: Gestión de Números (NUEVO DUAL LIST BOX) -->
    <div
      id="numberManagementModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO -->
        <div class="p-6 border-b bg-white">
          <div class="flex justify-between items-start">
            <div class="flex flex-col">
              <h3
                class="text-2xl font-bold text-gray-800 mb-1"
                id="number-manage-header-client-name"
              >
                Gestión de Números para: Cargando Nombre...
              </h3>
              <p class="text-sm font-medium text-gray-500">
                ID Ring Central: <span id="number-manage-header-rcid">...</span>
              </p>
            </div>
            <!-- Botón de Cerrar -->
            <button
              id="closeNumberModalBtn"
              class="text-gray-400 hover:text-gray-600 transition duration-150"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- CUERPO DUAL LIST SCROLLEABLE -->
        <div class="overflow-y-auto p-6 flex flex-col lg:flex-row gap-4">
          <!-- Columna 1: DIDs Disponibles (Izquierda) -->
          <div class="flex-1 border p-4 rounded-xl shadow-lg bg-gray-50">
            <div
              class="flex justify-between items-center border-b pb-3 mb-3 text-lg font-semibold text-gray-700"
            >
              <h4 class="flex items-center">DIDs Disponibles</h4>
              <span
                id="availableCount"
                class="bg-mcm-blue text-white rounded-full px-3 py-1 text-sm font-bold"
                >0</span
              >
            </div>

            <!-- Controles de Búsqueda -->
            <div class="mb-4">
              <label class="form-label" for="availableDIDsSearch"
                >BUSCAR DIDS</label
              >
              <input
                type="text"
                id="availableDIDsSearch"
                class="form-input"
                placeholder="+5255..."
              />
            </div>

            <!-- Lista de DIDs Disponibles -->
            <div
              id="availableDIDsList"
              class="bg-white rounded-lg max-h-96 overflow-y-auto p-2 space-y-2"
            >
              <!-- Se cargará automáticamente al abrir el modal -->
            </div>
          </div>

          <!-- Columna 2: Botones de Transferencia (Centro) -->
          <div
            class="flex flex-row lg:flex-col justify-center items-center p-4 lg:space-y-4 lg:space-x-0 space-x-4"
          >
            <!-- Botón de Transferencia Individual/Múltiple (Seleccionados a la derecha) -->
            <button
              id="transferToAccountBtn"
              class="bg-mcm-dark-green hover:bg-mcm-green text-white font-bold p-2 rounded-lg shadow transition duration-150 disabled:opacity-50"
              disabled
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 transform lg:rotate-0 rotate-90"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M13 5l7 7-7 7M5 12h14"
                />
              </svg>
            </button>

            <!-- Botón de Transferencia Individual/Múltiple (Seleccionados a la izquierda) -->
            <button
              id="transferFromAccountBtn"
              class="bg-mcm-red hover:bg-red-700 text-white font-bold p-2 rounded-lg shadow transition duration-150 disabled:opacity-50"
              disabled
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 transform lg:rotate-0 rotate-90"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M11 19l-7-7 7-7m8 14l-7-7 7-7"
                />
              </svg>
            </button>
          </div>

          <!-- Columna 3: Números de Cuenta (Derecha) -->
          <div class="flex-1 border p-4 rounded-xl shadow-lg bg-gray-100">
            <div
              class="flex justify-between items-center border-b pb-3 mb-3 text-lg font-semibold text-gray-700"
            >
              <h4 class="flex items-center">Números de Cuenta</h4>
              <span
                id="accountNumbersCount"
                class="bg-mcm-red text-white rounded-full px-3 py-1 text-sm font-bold"
                >0</span
              >
            </div>

            <!-- Controles de Búsqueda de Cuenta (REMOVIDOS: ID Ring Central y CARGAR TABLA) -->
            <div class="mb-4">
              <!-- Espacio de relleno para mantener el formato -->
            </div>

            <!-- Lista de Números de Cuenta -->
            <div
              id="accountNumbersList"
              class="bg-white rounded-lg max-h-96 overflow-y-auto p-2 space-y-2"
            >
              <div
                class="p-4 text-gray-500 text-center flex flex-col items-center justify-center h-full"
              >
                <svg
                  xmlns="http://www.w3.org/2ood-0"
                  class="h-10 w-10 text-gray-300 mb-2"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-5a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                  />
                </svg>
                <span>Sin números asignados</span>
              </div>
            </div>

            <!-- Botones de Acción de Cuenta -->
            <div class="mt-4 flex justify-between space-x-2">
              <button
                id="assignMainNumberBtn"
                class="w-full bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow text-sm transition disabled:opacity-50"
                disabled
              >
                ASIGNAR MAIN NUMBER
              </button>
            </div>
          </div>
        </div>

        <!-- FOOTER FIJO -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <button
            id="saveNumberChangesBtn"
            class="bg-mcm-green hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm disabled:opacity-50"
            disabled
          >
            GUARDAR CAMBIOS
          </button>
        </div>
      </div>
    </div>

    <!-- Modal 5: Registro de Portabilidad (NUEVO) -->
    <div
      id="portabilityModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO -->
        <div class="flex justify-between items-center p-6 border-b bg-white">
          <h3 class="text-xl font-semibold text-gray-800">
            Registro de Solicitud: Nueva Portabilidad
          </h3>
          <button
            id="closePortabilityModalBtn"
            class="text-gray-400 hover:text-gray-600 transition duration-150"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- FORMULARIO SCROLLEABLE -->
        <form id="portabilityModalForm" class="overflow-y-auto p-6 space-y-6">
          <!-- Alerta de Errores -->
          <div
            id="portabilityAlert"
            class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm font-medium"
          >
            <!-- Mensajes de error se inyectan aquí -->
          </div>

          <!-- DATOS GENERALES DE LA SOLICITUD -->
          <div class="border p-4 rounded-xl shadow-inner bg-gray-50 space-y-4">
            <h4 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">
              Datos Generales de la Solicitud
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- DIDA (DONADOR) - CAMBIADO A SELECT -->
              <div class="space-y-2">
                <label class="form-label" for="portabilityDIDA"
                  >DIDA (Donador)</label
                >
                <select id="portabilityDIDA" class="form-input" required>
                  <option value="" disabled selected>
                    Seleccione Operador
                  </option>
                  <option value="Telmex">Telmex</option>
                  <option value="AT&T">AT&T</option>
                  <option value="Axtel">Axtel</option>
                  <option value="Izzi">Izzi</option>
                  <option value="Otro">Otro Operador</option>
                </select>
              </div>

              <!-- FECHA DE SOLICITUD -->
              <div class="space-y-2">
                <label class="form-label" for="portabilityFechaSolicitud"
                  >Fecha de Solicitud</label
                >
                <input
                  type="date"
                  id="portabilityFechaSolicitud"
                  class="form-input"
                  required
                />
              </div>

              <!-- TIPO DE DID -->
              <div class="space-y-2">
                <label class="form-label">Tipo de DID</label>
                <div class="flex items-center space-x-6">
                  <div class="flex items-center">
                    <input
                      id="didGeografico"
                      type="radio"
                      name="tipoDID"
                      value="8"
                      class="h-4 w-4 text-mcm-blue border-gray-300 focus:ring-mcm-blue"
                      required
                    />
                    <label
                      for="didGeografico"
                      class="ml-2 block text-sm font-medium text-gray-700"
                    >
                      8 - Geográfico
                    </label>
                  </div>
                  <div class="flex items-center">
                    <input
                      id="didNoGeografico"
                      type="radio"
                      name="tipoDID"
                      value="9"
                      class="h-4 w-4 text-mcm-blue border-gray-300 focus:ring-mcm-blue"
                      required
                    />
                    <label
                      for="didNoGeografico"
                      class="ml-2 block text-sm font-medium text-gray-700"
                    >
                      9 - No Geográfico
                    </label>
                  </div>
                </div>
              </div>

              <!-- FECHA DE EJECUCIÓN -->
              <div class="space-y-2">
                <label class="form-label" for="portabilityFechaEjecucion"
                  >Fecha de Ejecución</label
                >
                <input
                  type="date"
                  id="portabilityFechaEjecucion"
                  class="form-input"
                  required
                />
              </div>
            </div>
          </div>

          <!-- CARGA DE NÚMEROS TELEFÓNICOS -->
          <div class="border p-4 rounded-xl shadow-inner bg-gray-50 space-y-4">
            <h4 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">
              Carga de Números Telefónicos
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- OPCIÓN A: CARGA MANUAL -->
              <div class="border p-4 rounded-lg bg-white space-y-3">
                <p class="font-medium text-gray-800 text-sm">
                  Opción A: Carga Manual
                </p>
                <p class="text-xs text-gray-500">
                  Ingrese un número por línea (para simulación, solo una
                  entrada).
                </p>
                <div class="flex space-x-2">
                  <input
                    type="text"
                    id="manualNumberInput"
                    class="form-input p-2 w-full"
                    placeholder="+52 55 1234 5678"
                  />
                  <button
                    type="button"
                    id="addNumberToListBtn"
                    class="bg-mcm-blue hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow text-sm transition whitespace-nowrap"
                  >
                    Agregar a la Lista
                  </button>
                </div>
              </div>

              <!-- OPCIÓN B: CARGA MASIVA (SIMULADA) -->
              <div class="border p-4 rounded-lg bg-white space-y-3">
                <p class="font-medium text-gray-800 text-sm">
                  Opción B: Carga Masiva (por Archivo)
                </p>
                <p class="text-xs text-gray-500">
                  Solo se aceptan archivos (.csv, .txt) con un número por línea.
                </p>
                <div class="file-input-wrapper">
                  <button
                    type="button"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow text-sm transition"
                  >
                    Seleccionar archivo
                  </button>
                  <span
                    id="fileNameDisplay"
                    class="text-sm text-gray-600 ml-4 truncate"
                    >Ningún archivo seleccionado</span
                  >
                  <input
                    type="file"
                    id="massiveFileInput"
                    accept=".csv,.txt"
                    onchange="handleFileUpload(event)"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- TABLA: NÚMEROS PENDIENTES DE CONFIRMACIÓN -->
          <div class="space-y-4">
            <h4
              class="text-lg font-semibold text-gray-700 border-l-4 border-mcm-blue pl-3"
            >
              Tabla: Números Pendientes de Confirmación
            </h4>
            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="portabilityNumbersTableContainer"
            >
              <!-- Tabla inyectada por JS (renderPendingNumbersTable) -->
              <p class="p-4 text-center text-gray-500">
                No hay números pendientes de confirmación.
              </p>
            </div>
          </div>
        </form>

        <!-- FOOTER FIJO -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <button
            id="cancelPortabilityBtn"
            type="button"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Cancelar
          </button>

          <button
            id="registerPortabilityBtn"
            type="submit"
            class="bg-mcm-blue hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow uppercase text-sm"
          >
            Registrar Portabilidad
          </button>
        </div>
      </div>
    </div>

    <!-- Modal 6: Detalle de Portabilidad (NUEVO) -->
    <div
      id="portabilityDetailsModal"
      class="modal fixed inset-0 hidden bg-gray-900 bg-opacity-85 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden transform transition-all duration-300 flex flex-col max-h-[90vh]"
      >
        <!-- HEADER FIJO -->
        <div class="p-6 border-b bg-white">
          <div class="flex justify-between items-start">
            <!-- Título Principal -->
            <div class="flex flex-col">
              <h3
                class="text-2xl font-bold text-gray-800 mb-1"
                id="port-detail-header-id"
              >
                Detalles de Portabilidad: #PORT-XXX
              </h3>
              <!-- Tenant y RC ID (Asumimos que la cuenta de destino es el Tenant) -->
              <p class="text-sm font-medium text-gray-500">
                Tenant: <span id="port-detail-tenant">N/A</span>
              </p>
            </div>
            <!-- Botón de Cerrar -->
            <button
              id="closePortabilityDetailsBtn"
              class="text-gray-400 hover:text-gray-600 transition duration-150"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- CUERPO SCROLLEABLE -->
        <div class="overflow-y-auto p-6 space-y-6">
          <!-- DATOS GENERALES DE LA SOLICITUD (Read-Only) -->
          <div class="border p-4 rounded-xl shadow-inner bg-gray-50 space-y-4">
            <h4 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">
              Datos Generales de la Solicitud
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- FILA 1 -->
              <div>
                <label class="form-label">Tipo de Portabilidad:</label>
                <div id="port-detail-tipo-port" class="read-only-text">N/A</div>
              </div>
              <div>
                <label class="form-label">Tipo de DID:</label>
                <div id="port-detail-tipo-did" class="read-only-text">N/A</div>
              </div>

              <!-- FILA 2 -->
              <div>
                <label class="form-label">Fecha de Solicitud:</label>
                <div id="port-detail-fecha-solicitud" class="read-only-text">
                  N/A
                </div>
              </div>
              <div>
                <label class="form-label">Fecha de Ejecución:</label>
                <div id="port-detail-fecha-ejecucion" class="read-only-text">
                  N/A
                </div>
              </div>

              <!-- FILA 3 (Operadores) -->
              <div>
                <label class="form-label">Donador (DIDA):</label>
                <div id="port-detail-donador" class="read-only-text">N/A</div>
              </div>
              <div>
                <label class="form-label">Receptor (RIDA):</label>
                <div id="port-detail-receptor" class="read-only-text">N/A</div>
              </div>

              <!-- FILA 4 (Métricas) -->
              <div>
                <label class="form-label">Total DIDs Solicitados:</label>
                <div
                  id="port-detail-total-dids"
                  class="read-only-text bg-mcm-light-blue text-mcm-blue font-bold"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <!-- TABLA: NÚMEROS PORTADOS -->
          <div class="space-y-4">
            <h4
              class="text-lg font-semibold text-gray-700 border-l-4 border-mcm-blue pl-3"
            >
              Números Portados
            </h4>
            <div
              class="overflow-x-auto rounded-lg border shadow"
              id="portabilityNumbersDetailsTableContainer"
            >
              <p class="p-4 text-center text-gray-500">Cargando números...</p>
            </div>
          </div>
        </div>

        <!-- FOOTER FIJO -->
        <div class="p-6 border-t bg-white flex justify-end space-x-3">
          <button
            type="button"
            id="closePortabilityDetailsFooterBtn"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg shadow uppercase text-sm transition duration-150"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- SCRIPT DEL MODAL Y TABLA -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- FIREBASE SETUP (MANDATORY TEMPLATE) ---
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig = JSON.parse(
        typeof __firebase_config !== "undefined" ? __firebase_config : "{}"
      );

      let app, db, auth, userId;
      let isAuthReady = false;

      // Function to initialize Firebase and authenticate
      async function initFirebase() {
        try {
          if (Object.keys(firebaseConfig).length === 0) {
            // Fallback for mock environment if no config provided
            console.log(
              "Using mock data as Firebase configuration is missing."
            );
            isAuthReady = true;
            renderTable();
            renderNumbersTable();
            renderPortabilityTables(); // Inyectar datos iniciales de Portabilidad
            return;
          }
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Initial Authentication check
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }

          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              console.log("Authenticated user ID:", userId);
            } else {
              userId = null;
              console.log("User is signed out.");
            }
            isAuthReady = true;
            renderTable(); // Re-render once authenticated
            renderNumbersTable(); // Re-render numbers table too
            renderPortabilityTables(); // Re-render portability tables too
          });
        } catch (error) {
          console.error("Error initializing Firebase or signing in:", error);
        }
      }
      // --- END FIREBASE SETUP ---

      // GLOBAL: Almacena la data de la cuenta actualmente en el modal de Detalles/Gestión
      let activeAccountForManagement = null;

      // GLOBALES PARA GESTIÓN DE NÚMEROS (DUAL LIST)
      let availableDIDs = []; // Números disponibles (a la izquierda)
      let accountNumbers = []; // Números de la cuenta (a la derecha)
      // CAMBIADO: Ahora son arrays para soportar multiselección
      let selectedDIDs = []; // DIDs seleccionados en la columna izquierda
      let selectedAccountNumbers = []; // Números seleccionados en la columna derecha

      // GLOBALES PARA REGISTRO DE PORTABILIDAD (NUEVO)
      let pendingPortabilityNumbers = [
        { id: 1, number: "+525512345678" },
        { id: 2, number: "+525598765432" },
        { id: 3, number: "+525533334444" },
      ];
      let currentPortabilityId = 4; // Counter for new numbers

      // Mock de datos para simular una cuenta capturada.
      const MOCK_ACCOUNTS = [
        {
          id_ring_central: "123456789",
          tenant: "Brian Aguirre Guerra",
          oportunidad_id: "123456", // OP ID para buscar
          op_id: "123456", // Detalle de OP
          client_name: "Mega Comunicaciones S.A. de C.V.",
          client_street: "Avenida Principal #100",
          client_colony: "Centro",
          client_city: "Monterrey",
          client_state: "Nuevo León",
          client_country: "México",
          client_zip: "64000",
          pm_ot: "OT 1",
          pm_responsible: "Juan Pérez (PM)",
          pm_email: "juan.perez@mcm.com",
          licensing: [
            {
              id: "lic-001",
              sku: "159",
              type: "Estandar",
              product: "qwertymy",
              package: "N/A",
              pkg_id: "951",
              lic_id: "asdf",
              qty: 10,
              subfam: "poiuy",
            },
            {
              id: "lic-002",
              sku: "201",
              type: "Premium",
              product: "zxcyb",
              package: "PQT-A",
              pkg_id: "1002",
              lic_id: "ghjk",
              qty: 5,
              subfam: "lmnb",
            },
          ],
          // Los números de la cuenta inicial son solo los asignados
          numbers: [
            {
              id: "did-5678",
              type: "Main Number",
              number: "+525512345678",
              status: "Asignado",
              rcid: "12345-N1",
              quarantine: "No",
            },
            {
              id: "did-0001",
              type: "Inventory",
              number: "+525590000001",
              status: "Disponible",
              rcid: null,
              quarantine: "No",
            }, // Inventario no tiene RCID/Tenant
            {
              id: "did-0002",
              type: "Inventory",
              number: "+525590000002",
              status: "Disponible",
              rcid: null,
              quarantine: "No",
            }, // Inventario no tiene RCID/Tenant
            {
              id: "did-0003",
              type: "Inventory",
              number: "+525590000003",
              status: "Asignado",
              rcid: "12345-N4",
              quarantine: "Si",
            },
          ],
        },
        {
          id_ring_central: "987654321",
          tenant: "Mayra Lorena Aguilar Olivares",
          oportunidad_id: "654321", // OP ID para buscar
          op_id: "654321",
          client_name: "Otra Empresa S. de R.L.",
          client_street: "Calle Secundaria #20",
          client_colony: "La Loma",
          client_city: "Guadalajara",
          client_state: "Jalisco",
          client_country: "México",
          client_zip: "44000",
          pm_ot: "OT 2",
          pm_responsible: "María López (PM)",
          pm_email: "maria.lopez@mcm.com",
          licensing: [
            {
              id: "lic-003",
              sku: "100",
              type: "Basica",
              product: "telco",
              package: "N/A",
              pkg_id: "777",
              lic_id: "bbbb",
              qty: 20,
              subfam: "qwer",
            },
          ],
          numbers: [
            {
              id: "did-5432",
              type: "Main Number",
              number: "+523398765432",
              status: "Asignado",
              rcid: "98765-N1",
              quarantine: "No",
            },
            {
              id: "did-1000",
              type: "Inventory",
              number: "+3350001000",
              status: "Disponible",
              rcid: null,
              quarantine: "No",
            },
          ],
        },
      ];

      // Mock de DIDs que están "disponibles" globalmente (para la lista izquierda)
      const MOCK_AVAILABLE_DIDS_POOL = [
        { id: "did-0111", number: "+525541723418", type: "Inventory" },
        { id: "did-0112", number: "+525541723434", type: "Inventory" },
        { id: "did-0113", number: "+526249800774", type: "Inventory" },
        { id: "did-0114", number: "+525540000000", type: "Inventory" },
        { id: "did-0115", number: "+525540000005", type: "Inventory" },
        { id: "did-0116", number: "+525540000006", type: "Inventory" },
        { id: "did-0117", number: "+525540000007", type: "Inventory" },
      ];

      // --- MOCK DATA PARA LA VISTA DE INVENTARIO DE NÚMEROS (Junta todos los números) ---
      const MOCK_NUMBERS_VIEW = [
        ...MOCK_ACCOUNTS[0].numbers
          .map((n) => ({
            ...n,
            tenant: n.status === "Asignado" ? MOCK_ACCOUNTS[0].tenant : "N/A", // Solo asignados tienen Tenant
            rcid_cuenta: MOCK_ACCOUNTS[0].id_ring_central,
          }))
          .filter((n) => n.status === "Asignado"), // Solo números asignados a Brian

        ...MOCK_ACCOUNTS[1].numbers
          .map((n) => ({
            ...n,
            tenant: n.status === "Asignado" ? MOCK_ACCOUNTS[1].tenant : "N/A", // Solo asignados tienen Tenant
            rcid_cuenta: MOCK_ACCOUNTS[1].id_ring_central,
          }))
          .filter((n) => n.status === "Asignado"), // Solo números asignados a Mayra

        // Agregar números disponibles (simulando inventario no asignado)
        {
          number: "+528110000000",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
        {
          number: "+528110000001",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
        {
          number: "+523310000000",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
        {
          number: "+525599999999",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
        {
          number: "+525599999998",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
        {
          number: "+525599999997",
          status: "Disponible",
          quarantine: "No",
          tenant: "N/A",
          rcid: null,
          rcid_cuenta: null,
        },
      ];

      // --- MOCK DATA PARA LA VISTA DE PORTABILIDADES (ACTUALIZADO para 1 Tenant) ---
      // n_tipo_port: 1 = Alta (MCM Receptor), 0 = Baja (MCM Donador)
      const MOCK_PORTABILITY_DATA = {
        portedNumbers: [
          // id_cuenta es el ID de la cuenta RC al que se asignó, o "Sin asignar"
          {
            id: 18,
            id_cuenta: "2443821032",
            did_portado: "+526249800778",
            id_portabilidad: 13,
            estado_portacion: "Completado",
          },
          {
            id: 19,
            id_cuenta: "2443821458",
            did_portado: "+52552625956",
            id_portabilidad: 13,
            estado_portacion: "Completado",
          },
          {
            id: 20,
            id_cuenta: "987654321",
            did_portado: "+525510000000",
            id_portabilidad: 14,
            estado_portacion: "Pendiente",
          },
          {
            id: 21,
            id_cuenta: "123456789",
            did_portado: "+528181234567",
            id_portabilidad: 15,
            estado_portacion: "Completado",
          },
          {
            id: 22,
            id_cuenta: "123456789",
            did_portado: "+528181234568",
            id_portabilidad: 15,
            estado_portacion: "Completado",
          },
          {
            id: 23,
            id_cuenta: "123456789",
            did_portado: "+528181234569",
            id_portabilidad: 15,
            estado_portacion: "Rechazado",
          },
          {
            id: 24,
            id_cuenta: "123456789",
            did_portado: "+528181234570",
            id_portabilidad: 15,
            estado_portacion: "Completado",
          },
          {
            id: 25,
            id_cuenta: "2443821059",
            did_portado: "+528181234571",
            id_portabilidad: 15,
            estado_portacion: "Completado",
          },
        ],
        registers: [
          // Alta (n_tipo_port: 1): Telmex es Donador, MCM es Receptor.
          {
            id: 13,
            PortId: "PORT-001",
            total_dids: 2,
            tenant: "Brian Aguirre Guerra",
            n_tipo_port: 1,
            fecha_solicitud: "2025-11-13",
            fecha_ejecucion: "2025-11-13",
            id_tipo_did: 8,
            did_donador: 0,
            did_receptor: 0,
            dida_donador: "Telmex",
          },
          // Baja (n_tipo_port: 0): MCM es Donador, AT&T es Receptor.
          {
            id: 14,
            PortId: "PORT-002",
            total_dids: 1,
            tenant: "Mayra Lorena Aguilar Olivares",
            n_tipo_port: 0,
            fecha_solicitud: "2025-11-20",
            fecha_ejecucion: "2025-11-25",
            id_tipo_did: 9,
            did_donador: 1,
            did_receptor: 0,
            dida_donador: "AT&T",
          },
          // Alta (n_tipo_port: 1): Axtel es Donador, MCM es Receptor.
          {
            id: 15,
            PortId: "PORT-003",
            total_dids: 5,
            tenant: "Brian Aguirre Guerra",
            n_tipo_port: 1,
            fecha_solicitud: "2025-12-01",
            fecha_ejecucion: "2025-12-05",
            id_tipo_did: 8,
            did_donador: 0,
            did_receptor: 1,
            dida_donador: "Axtel",
          },
          // Baja (n_tipo_port: 0): MCM es Donador, Izzi es Receptor.
          {
            id: 16,
            PortId: "PORT-004",
            total_dids: 3,
            tenant: "Mayra Lorena Aguilar Olivares",
            n_tipo_port: 0,
            fecha_solicitud: "2025-12-05",
            fecha_ejecucion: "2025-12-10",
            id_tipo_did: 9,
            did_donador: 1,
            did_receptor: 0,
            dida_donador: "Izzi",
          },
          // Alta (n_tipo_port: 1): Otro es Donador, MCM es Receptor.
          {
            id: 17,
            PortId: "PORT-005",
            total_dids: 1,
            tenant: "Brian Aguirre Guerra",
            n_tipo_port: 1,
            fecha_solicitud: "2025-12-10",
            fecha_ejecucion: "2025-12-15",
            id_tipo_did: 8,
            did_donador: 0,
            did_receptor: 0,
            dida_donador: "Otro",
          },
          // Simulación de 50 registros adicionales (con datos repetidos para paginación)
          ...Array.from({ length: 50 }).map((_, i) => ({
            id: 18 + i,
            PortId: `PORT-${18 + i}`,
            total_dids: (i % 5) + 1,
            tenant:
              i % 2 === 0
                ? "Brian Aguirre Guerra"
                : "Mayra Lorena Aguilar Olivares",
            n_tipo_port: i % 2,
            fecha_solicitud: `2025-${String((i % 12) + 1).padStart(
              2,
              "0"
            )}-${String((i % 28) + 1).padStart(2, "0")}`,
            fecha_ejecucion: `2025-${String((i % 12) + 1).padStart(
              2,
              "0"
            )}-${String((i % 28) + 2).padStart(2, "0")}`,
            id_tipo_did: i % 2 === 0 ? 8 : 9,
            did_donador: i % 2 === 0 ? 0 : 1,
            did_receptor: i % 2 === 0 ? 1 : 0,
            dida_donador: ["Telmex", "AT&T", "Axtel", "Izzi", "Otro"][i % 5],
          })),
        ],
      };

      // Función auxiliar para buscar números portados por ID de Portabilidad
      function getPortedNumbersByPortId(portId) {
        return MOCK_PORTABILITY_DATA.portedNumbers.filter(
          (n) => n.id_portabilidad === portId
        );
      }

      /* -------------------------------------------
			DATA DE EJEMPLO (85 cuentas generadas para paginación)
			--------------------------------------------*/
      const accounts = Array.from({ length: 85 }).map((_, i) => ({
        id: String(100 + i),
        tenant: MOCK_ACCOUNTS[i % 2].tenant.split(" ")[0] + " " + ((i % 7) + 1),
        opp: String(85246 + i),
      }));

      // Fusionar datos mockeados con datos generados
      accounts[0] = {
        id: MOCK_ACCOUNTS[0].id_ring_central,
        tenant: MOCK_ACCOUNTS[0].tenant,
        opp: MOCK_ACCOUNTS[0].oportunidad_id,
      };
      accounts[1] = {
        id: MOCK_ACCOUNTS[1].id_ring_central,
        tenant: MOCK_ACCOUNTS[1].tenant,
        opp: MOCK_ACCOUNTS[1].oportunidad_id,
      };

      // --- VARIABLES DE ESTADO GLOBALES ---
      let activeView = "cuentas";
      let currentPageAccounts = 1;
      let pageSizeAccounts = 10;
      let filteredAccounts = accounts;

      let currentPageNumbers = 1;
      let pageSizeNumbers = 10;
      let filteredNumbers = MOCK_NUMBERS_VIEW;

      // NUEVAS VARIABLES DE ESTADO PARA PORTABILIDADES
      let currentPagePortability = 1;
      let pageSizePortability = 5; // Usamos 5 por defecto para portabilidad
      let filteredPortability = MOCK_PORTABILITY_DATA.registers;

      // Almacena la cuenta cargada temporalmente en el modal de agregar
      let currentLoadedAccount = null;

      // Variables de estado y altura para filtros
      let originalHeightNumbers = 0;
      let filtersVisibleNumbers = true;
      let originalHeightPortability = 0; // Nueva variable para portabilidad
      let filtersVisiblePortability = true; // Nueva variable para portabilidad

      // --- CAMBIO DE VISTA ---
      function changeView(viewId) {
        activeView = viewId;

        // Elementos de filtro (para asegurar la altura correcta al mostrar)
        const numbersFilterBar = document.getElementById("numbersFilterBar");
        const numbersFilterIcon = document.getElementById("numbersFilterIcon");
        const portabilityFilterBar = document.getElementById(
          "portabilityFilterBar"
        );
        const portabilityFilterIcon = document.getElementById(
          "portabilityFilterIcon"
        );

        // Ocultar todas las vistas
        document.getElementById("view-cuentas").classList.add("hidden");
        document.getElementById("view-numeros").classList.add("hidden");
        document.getElementById("view-portabilidades").classList.add("hidden");

        // Mostrar la vista activa
        const activeViewElement = document.getElementById(`view-${viewId}`);
        if (activeViewElement) {
          activeViewElement.classList.remove("hidden");
        }

        // Actualizar la clase activa de las pestañas
        document.querySelectorAll("nav a").forEach((tab) => {
          tab.classList.remove(
            "text-mcm-blue",
            "border-mcm-blue",
            "font-semibold"
          );
          tab.classList.add(
            "border-transparent",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
        });

        const activeTab = document.querySelector(`[data-view="${viewId}"]`);
        if (activeTab) {
          activeTab.classList.add(
            "text-mcm-blue",
            "border-mcm-blue",
            "font-semibold"
          );
          activeTab.classList.remove(
            "border-transparent",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
        }

        // Renderizar la tabla correspondiente si es necesario
        if (viewId === "numeros") {
          if (numbersFilterBar) {
            if (filtersVisibleNumbers) {
              numbersFilterBar.style.maxHeight = "none";
              originalHeightNumbers = numbersFilterBar.scrollHeight;
              numbersFilterBar.style.maxHeight = originalHeightNumbers + "px";

              numbersFilterBar.classList.remove("hidden", "max-h-0");
              numbersFilterBar.classList.add("p-4", "mb-6");
              if (numbersFilterIcon)
                numbersFilterIcon.classList.remove("rotate-180");
            } else {
              numbersFilterBar.style.maxHeight = "0px";
            }
          }
          renderNumbersTable();
        } else if (viewId === "cuentas") {
          renderTable();
        } else if (viewId === "portabilidades") {
          // Lógica similar para el filtro de Portabilidades
          if (portabilityFilterBar) {
            if (filtersVisiblePortability) {
              portabilityFilterBar.style.maxHeight = "none";
              originalHeightPortability = portabilityFilterBar.scrollHeight;
              portabilityFilterBar.style.maxHeight =
                originalHeightPortability + "px";

              portabilityFilterBar.classList.remove("hidden", "max-h-0");
              portabilityFilterBar.classList.add("p-4", "mb-6");
              if (portabilityFilterIcon)
                portabilityFilterIcon.classList.remove("rotate-180");
            } else {
              portabilityFilterBar.style.maxHeight = "0px";
            }
          }
          renderPortabilityTables();
        }
      }

      // ----------------------------------------------------------------
      // DATOS MOCK Y VARIABLES GLOBALES (NUEVO)
      // ----------------------------------------------------------------

      // Simulación de clientes que vienen de una API o BD
      const MOCK_CLIENTS_RC = [
        { id: 101, rc_account_id: "123456789", name: "Brian Aguirre Guerra" },
        {
          id: 102,
          rc_account_id: "987654321",
          name: "Mayra Lorena Aguilar Olivares",
        },
      ];

      // Variable global crítica: Almacena el cliente que manda sobre toda la vista
      let currentSelectedTenantName = "";

      // ----------------------------------------------------------------
      // INICIALIZACIÓN (EDITADO)
      // ----------------------------------------------------------------
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Inicializar el Super Filtro (NUEVO)
        initSuperFilter();

        // 2. Listeners existentes
        document
          .getElementById("searchPortabilityFiltersBtn")
          .addEventListener("click", applyPortabilityFilters);

        // Listener modificado para "Limpiar" (ahora llama a la versión nueva)
        document
          .getElementById("clearPortabilityFiltersBtn")
          .addEventListener("click", () => clearPortabilityFilters(true));

        // Listener del Super Filtro (NUEVO)
        document
          .getElementById("superFilterTenant")
          .addEventListener("change", handleSuperFilterChange);

        // Render inicial (probablemente vacío hasta que seleccionen cliente)
        renderPortabilityTables();
      });

      // ----------------------------------------------------------------
      // LÓGICA DEL SUPER FILTRO (NUEVO)
      // ----------------------------------------------------------------
      function initSuperFilter() {
        const select = document.getElementById("superFilterTenant");
        select.innerHTML =
          '<option value="">-- Seleccione un Cliente para comenzar --</option>';

        MOCK_CLIENTS_RC.forEach((client) => {
          const option = document.createElement("option");
          // Usamos el 'name' como valor clave porque tus datos de portabilidad usan 'tenant' como string
          option.value = client.name;
          option.textContent = `[${client.rc_account_id}] - ${client.name}`;
          select.appendChild(option);
        });
      }

      function handleSuperFilterChange(e) {
        const selectedTenant = e.target.value;
        const mainContainer = document.getElementById(
          "mainPortabilityContainer"
        );
        const openModalBtn = document.getElementById("openPortabilityModalBtn");
        const titleSpan = document.getElementById("selectedClientTitle");
        const tableBody = document.getElementById("portabilityRegisterTable");
        const pageInfo = document.getElementById("portabilityPageInfo");

        if (!selectedTenant) {
          // BLOQUEAR TODO SI NO HAY CLIENTE
          currentSelectedTenantName = "";
          mainContainer.classList.add("opacity-50", "pointer-events-none");
          openModalBtn.disabled = true;
          titleSpan.textContent = "";
          tableBody.innerHTML = `<tr><td colspan="11" class="py-10 text-center text-gray-500 italic text-lg">☝️ Por favor, seleccione un cliente en la parte superior para ver sus portabilidades.</td></tr>`;
          pageInfo.textContent = "";
          return;
        }

        // ACTIVAR SI HAY CLIENTE
        currentSelectedTenantName = selectedTenant;
        mainContainer.classList.remove("opacity-50", "pointer-events-none");
        openModalBtn.disabled = false;

        const selectedText = e.target.options[e.target.selectedIndex].text;
        titleSpan.textContent = `> ${selectedText}`;

        // Resetear filtros secundarios y aplicar el filtro principal
        clearPortabilityFilters(false);
        applyPortabilityFilters();
      }

      // ----------------------------------------------------------------
      // LÓGICA DE LA VISTA DE PORTABILIDADES (NUEVO)
      // ----------------------------------------------------------------

      // Función auxiliar para fechas (MANTENIDA)
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const [year, month, day] = dateString.split("-");
        return `${day}/${month}/${year}`;
      }

      // Función auxiliar para comparar fechas (MANTENIDA)
      function compareDates(date1, date2) {
        if (!date1 || !date2) return true;
        return date1 <= date2;
      }

      // APLICAR FILTROS (EDITADO: Ahora depende de currentSelectedTenantName)
      function applyPortabilityFilters() {
        // Seguridad: Si no hay tenant seleccionado en el combo global, no mostrar nada
        if (!currentSelectedTenantName) return;

        const filters = {
          tenant: currentSelectedTenantName.toLowerCase(), // Usamos la variable global
          portId: document.getElementById("filterPortId").value.toLowerCase(),
          type: document.getElementById("filterPortType").value,
          dateStart: document.getElementById("filterPortDateStart").value,
          dateEnd: document.getElementById("filterPortDateEnd").value,
        };

        filteredPortability = MOCK_PORTABILITY_DATA.registers.filter((reg) => {
          // 1. Filtro Mandatorio: El tenant debe coincidir EXACTAMENTE con el seleccionado
          const tenantMatch = reg.tenant.toLowerCase() === filters.tenant;
          if (!tenantMatch) return false; // Si no es del cliente seleccionado, adiós.

          // 2. Filtros Secundarios
          const portIdMatch = reg.PortId.toLowerCase().includes(filters.portId);
          const typeMatch =
            filters.type === "" || String(reg.n_tipo_port) === filters.type;

          const dateSolicitud = reg.fecha_solicitud;
          const startDateMatch =
            !filters.dateStart ||
            compareDates(filters.dateStart, dateSolicitud);
          const endDateMatch =
            !filters.dateEnd || compareDates(dateSolicitud, filters.dateEnd);

          return portIdMatch && typeMatch && startDateMatch && endDateMatch;
        });

        currentPagePortability = 1;
        renderPortabilityTables();
      }

      // LIMPIAR FILTROS (EDITADO: No limpia el combo principal)
      function clearPortabilityFilters(shouldReload = true) {
        // NO limpiamos currentSelectedTenantName ni el combo 'superFilterTenant'
        document.getElementById("filterPortId").value = "";
        document.getElementById("filterPortType").value = "";
        document.getElementById("filterPortDateStart").value = "";
        document.getElementById("filterPortDateEnd").value = "";

        if (shouldReload) {
          currentPagePortability = 1;
          applyPortabilityFilters();
        }
      }

      // Función auxiliar para renderizar la tabla de Números Portados (Detalles)
      function generatePortedNumbersTableHTML(numbersData) {
        if (!numbersData || numbersData.length === 0) {
          return '<p class="p-4 text-gray-500 text-center">No se encontraron números portados asociados a este registro.</p>';
        }

        // Definición del ID Ring Central único para cada número.
        // Nota: Estamos usando did_portado como la clave de identificación temporal aquí.

        const tableRows = numbersData
          .map((num) => {
            // Usamos el id de la cuenta real (o el placeholder)
            const idCuentaRC = num.id_cuenta || "Sin asignar";

            // El estado ya no se muestra en esta tabla

            return `
							<tr class="hover:bg-gray-50">
								<td class="px-4 py-3 text-sm font-medium text-gray-900">${num.id}</td>
								<td class="px-4 py-3 text-sm font-mono text-gray-700">${num.did_portado}</td>
								<td class="px-4 py-3 text-sm font-medium text-gray-800">${idCuentaRC}</td>
							</tr>
						`;
          })
          .join("");

        return `
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-200 text-gray-700">
							<tr>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-[10%]">ID</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-[45%]">DID PORTADO</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-[45%]">ID Cuenta Ring Central</th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							${tableRows}
						</tbody>
					</table>
				`;
      }

      // Función para abrir el modal de detalles de Portabilidad
      function openPortabilityDetailsModal(portData) {
        const modal = document.getElementById("portabilityDetailsModal");

        const tipoPortabilidadText =
          portData.n_tipo_port === 1
            ? "Alta"
            : portData.n_tipo_port === 0
            ? "Baja"
            : "N/A";
        const tipoDIDText =
          portData.id_tipo_did === 8
            ? "8 - Geográfico"
            : portData.id_tipo_did === 9
            ? "9 - No Geográfico"
            : "N/A";

        // LÓGICA DE DONADOR/RECEPTOR (Alta vs Baja)
        const DONADOR =
          portData.n_tipo_port === 1 ? portData.dida_donador : "MCM";
        const RECEPTOR =
          portData.n_tipo_port === 1 ? "MCM" : portData.dida_donador;

        // 1. Actualizar Header
        document.getElementById(
          "port-detail-header-id"
        ).textContent = `Detalles de Portabilidad: #${portData.PortId}`;
        document.getElementById("port-detail-tenant").textContent =
          portData.tenant;

        // 2. Llenar Datos Generales
        document.getElementById("port-detail-tipo-port").textContent =
          tipoPortabilidadText;
        document.getElementById("port-detail-tipo-did").textContent =
          tipoDIDText;
        // Formato de fechas
        document.getElementById("port-detail-fecha-solicitud").textContent =
          formatDate(portData.fecha_solicitud);
        document.getElementById("port-detail-fecha-ejecucion").textContent =
          formatDate(portData.fecha_ejecucion);

        // Nuevos campos de Operadores
        document.getElementById("port-detail-donador").textContent = DONADOR;
        document.getElementById("port-detail-receptor").textContent = RECEPTOR;

        // Métricas
        document.getElementById("port-detail-total-dids").textContent =
          portData.total_dids;

        // 3. Cargar Números Portados
        const portedNumbers = getPortedNumbersByPortId(portData.id);
        const numbersContainer = document.getElementById(
          "portabilityNumbersDetailsTableContainer"
        );
        numbersContainer.innerHTML =
          generatePortedNumbersTableHTML(portedNumbers);

        showModal(modal);
        console.log(`Abriendo detalles para PortID: ${portData.PortId}`);
      }

      function renderPendingNumbersTable() {
        const container = document.getElementById(
          "portabilityNumbersTableContainer"
        );
        if (!container) return;

        if (pendingPortabilityNumbers.length === 0) {
          container.innerHTML =
            '<p class="p-4 text-center text-gray-500">No hay números pendientes de confirmación.</p>';
          return;
        }

        // Renderizar la tabla si hay datos
        const tableHtml = `
					<table id="pendingNumbersTable" class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-100">
							<tr>
								<th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[5%]">#</th>
								<th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-[80%]">Número Telefónico</th>
								<th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-[15%]">Acción</th>
							</tr>
						</thead>
						<tbody id="pendingNumbersTableBody" class="bg-white divide-y divide-gray-200">
							${pendingPortabilityNumbers
                .map(
                  (item, index) => `
								<tr class="hover:bg-red-50/50" data-id="${item.id}">
									<td class="px-4 py-3 text-sm font-medium text-gray-900">${index + 1}</td>
									<td class="px-4 py-3 text-sm font-mono text-gray-700">${item.number}</td>
									<td class="px-4 py-3 text-center">
										<button 
											type="button"
											class="text-red-600 hover:text-red-800 font-semibold text-xs" 
											onclick="removePortabilityNumber(${item.id})">
											Eliminar
										</button>
									</td>
								</tr>
							`
                )
                .join("")}
						</tbody>
					</table>
				`;
        container.innerHTML = tableHtml;
      }

      function addPortabilityNumber() {
        const input = document.getElementById("manualNumberInput");
        const number = input.value.trim();
        const alertBox = document.getElementById("portabilityAlert");

        alertBox.classList.add("hidden");

        if (!number || number.length < 8) {
          alertBox.textContent =
            "ERROR: Ingrese un número telefónico válido (mínimo 8 dígitos).";
          alertBox.classList.remove("hidden");
          return;
        }

        const cleanedNumber = number.replace(/[^+\d]/g, "");

        if (
          pendingPortabilityNumbers.some(
            (item) => item.number === cleanedNumber
          )
        ) {
          alertBox.textContent = `ERROR: El número ${cleanedNumber} ya está en la lista.`;
          alertBox.classList.remove("hidden");
          return;
        }

        pendingPortabilityNumbers.push({
          id: currentPortabilityId++,
          number: cleanedNumber,
        });

        input.value = "";
        renderPendingNumbersTable();
        console.log(`Número ${cleanedNumber} agregado a la lista.`);
      }

      window.removePortabilityNumber = function (id) {
        pendingPortabilityNumbers = pendingPortabilityNumbers.filter(
          (item) => item.id !== id
        );
        renderPendingNumbersTable();
        console.log(`Número con ID ${id} eliminado.`);
      };

      // Mock for file upload (only console logging the selection)
      window.handleFileUpload = function (e) {
        const fileInput = e.target;
        const fileNameDisplay = document.getElementById("fileNameDisplay");

        if (fileInput.files.length > 0) {
          fileNameDisplay.textContent = fileInput.files[0].name;
          console.log(
            `Archivo seleccionado para carga masiva: ${fileInput.files[0].name}. (MOCK: Se necesitaría lógica de procesamiento de CSV/TXT).`
          );
          // Aquí iría la lógica para leer y parsear el archivo
        } else {
          fileNameDisplay.textContent = "Ningún archivo seleccionado";
        }
      };

      function registerPortability(e) {
        e.preventDefault(); // Detener el envío del formulario

        // MODIFICACIÓN: Obtener el valor del select
        const dida = document.getElementById("portabilityDIDA").value;
        const fechaSolicitud = document.getElementById(
          "portabilityFechaSolicitud"
        ).value;
        const tipoDID = document.querySelector(
          'input[name="tipoDID"]:checked'
        )?.value;
        const fechaEjecucion = document.getElementById(
          "portabilityFechaEjecucion"
        ).value;
        const alertBox = document.getElementById("portabilityAlert");

        alertBox.classList.add("hidden");

        if (
          !dida ||
          dida === "" ||
          !fechaSolicitud ||
          !tipoDID ||
          !fechaEjecucion
        ) {
          alertBox.textContent =
            "ERROR: Todos los campos de Datos Generales son obligatorios.";
          alertBox.classList.remove("hidden");
          return;
        }

        if (pendingPortabilityNumbers.length === 0) {
          alertBox.textContent =
            "ERROR: Debe cargar al menos un número telefónico.";
          alertBox.classList.remove("hidden");
          return;
        }

        const payload = {
          dida: dida, // DIDA ahora es el valor del select
          fechaSolicitud: fechaSolicitud,
          tipoDID: tipoDID === "8" ? "Geográfico" : "No Geográfico",
          fechaEjecucion: fechaEjecucion,
          numeros: pendingPortabilityNumbers.map((n) => n.number),
          totalDIDs: pendingPortabilityNumbers.length,
        };

        console.log("--- REGISTRANDO NUEVA PORTABILIDAD (MOCK) ---");
        console.log(payload);

        // Simular éxito y cerrar modal
        alert(
          `Portabilidad PORT-XXX registrada con éxito para ${payload.totalDIDs} números, DIDA: ${payload.dida}.`
        );

        // Resetear y cerrar
        pendingPortabilityNumbers = [];
        currentPortabilityId = 1;
        document.getElementById("portabilityModalForm").reset();
        document.getElementById("fileNameDisplay").textContent =
          "Ningún archivo seleccionado";
        hideModal(document.getElementById("portabilityModal"));
        renderPortabilityTables(); // Re-render the main table
      }

      // Función para abrir el modal de Portabilidad
      function openPortabilityModal() {
        const modal = document.getElementById("portabilityModal");
        const form = document.getElementById("portabilityModalForm");

        // Limpiar y resetear el formulario (esto incluye los inputs y radio buttons)
        form.reset();
        document.getElementById("portabilityAlert").classList.add("hidden");
        pendingPortabilityNumbers = []; // Comenzar con lista vacía
        currentPortabilityId = 1;
        document.getElementById("fileNameDisplay").textContent =
          "Ningún archivo seleccionado";

        // Renderizar la tabla de números pendientes vacía
        renderPendingNumbersTable();

        // Inicializar fechas con hoy (opcional, pero útil para fechas)
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("portabilityFechaSolicitud").value = today;
        document.getElementById("portabilityFechaEjecucion").value = today; // O una semana después

        showModal(modal);
      }

      function renderPortabilityTables() {
        // 1. Obtener tamaño de página actual
        pageSizePortability = parseInt(
          document.getElementById("portabilityPageSize").value,
          10
        );

        const totalPages = Math.ceil(
          filteredPortability.length / pageSizePortability
        );

        // Ajustar currentPage si está fuera de límites
        if (currentPagePortability > totalPages)
          currentPagePortability = totalPages || 1;
        if (currentPagePortability < 1) currentPagePortability = 1;

        // Calcular datos de la página
        const start = (currentPagePortability - 1) * pageSizePortability;
        const end = start + pageSizePortability;
        const pageData = filteredPortability.slice(start, end);

        // 2. Renderizar Registro de Portabilidades
        const registerTable = document.getElementById(
          "portabilityRegisterTable"
        );

        if (pageData.length === 0) {
          registerTable.innerHTML = `<tr><td colspan="11" class="py-10 text-center text-gray-500">No se encontraron registros de portabilidad que coincidan con los filtros.</td></tr>`;
        } else {
          registerTable.innerHTML = pageData
            .map((reg) => {
              // Lógica de traducción de valores
              const tipoPortabilidadText =
                reg.n_tipo_port === 1
                  ? "Alta"
                  : reg.n_tipo_port === 0
                  ? "Baja"
                  : "N/A";
              const tipoDIDText =
                reg.id_tipo_did === 8
                  ? "Geográfico"
                  : reg.id_tipo_did === 9
                  ? "No Geográfico"
                  : "N/A";

              // Formatear Tenant: Ahora solo se espera un tenant (string)
              const tenantName = reg.tenant || "N/A";

              // LÓGICA DE DONADOR/RECEPTOR (Alta vs Baja)
              // Alta (1): Donador = DIDA_DONADOR, Receptor = MCM
              // Baja (0): Donador = MCM, Receptor = DIDA_DONADOR
              const DONADOR = reg.n_tipo_port === 1 ? reg.dida_donador : "MCM";
              const RECEPTOR = reg.n_tipo_port === 1 ? "MCM" : reg.dida_donador;

              // Contenido de la columna ACCIONES (Simulando los botones de Cuentas)
              const actionsHtml = `
							<td class="px-4 py-3 whitespace-nowrap text-center text-sm font-medium flex justify-center space-x-2">
								<!-- Botón de Ver Detalles -->
								<button class="action-button bg-mcm-blue hover:bg-blue-700 text-white view-portability-btn" data-portability-id="${reg.id}">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
									</svg>
								</button>

								<!-- Botón de Editar -->
								<button class="action-button bg-green-500 hover:bg-green-600 text-white">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4L9 9"/>
									</svg>
								</button>

								<!-- Botón de Eliminar -->
								<button class="action-button bg-red-500 hover:bg-red-600 text-white">
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4 a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
									</svg>
								</button>
							</td>
						`;

              // Ajustamos el ancho de la columna TENANT(S) en el HTML.
              return `
							<tr class="hover:bg-gray-50">
								<td class="px-4 py-3 text-sm font-medium text-gray-900">${reg.id}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${reg.PortId}</td>
								<td class="px-4 py-3 text-sm text-gray-700 text-center">${reg.total_dids}</td>
								<td class="px-4 py-3 text-sm font-medium text-gray-900 truncate" title="${tenantName}">${tenantName}</td>
								<td class="px-4 py-3 text-sm text-gray-700 text-center">
									<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                    reg.n_tipo_port === 1
                      ? "bg-mcm-green/70 text-gray-800"
                      : "bg-red-200 text-mcm-red"
                  }">
										${tipoPortabilidadText}
									</span>
								</td>
								<td class="px-4 py-3 text-sm text-gray-700">${formatDate(
                  reg.fecha_solicitud
                )}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${formatDate(
                  reg.fecha_ejecucion
                )}</td>
								<td class="px-4 py-3 text-sm text-gray-700 text-center">
									<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">
										${tipoDIDText}
									</span>
								</td>
								<td class="px-4 py-3 text-sm font-medium text-gray-800">${DONADOR}</td>
								<td class="px-4 py-3 text-sm font-medium text-gray-800">${RECEPTOR}</td>
								${actionsHtml}
							</tr>
						`;
            })
            .join("");
        }

        // 3. Actualizar paginación
        const totalItems = filteredPortability.length;
        const showingFrom = totalItems > 0 ? start + 1 : 0;
        const showingTo = Math.min(end, totalItems);

        document.getElementById(
          "portabilityPageInfo"
        ).textContent = `Mostrando ${showingFrom}-${showingTo} de ${totalItems} resultados (Página ${currentPagePortability} de ${
          totalPages || 1
        })`;

        document.getElementById("portabilityPrevPage").disabled =
          currentPagePortability === 1;
        document.getElementById("portabilityNextPage").disabled =
          currentPagePortability === totalPages || totalPages === 0;

        // Re-adjuntar listeners de vista de portabilidad
        attachPortabilityViewListeners();
      }

      // Función para adjuntar listeners de vista de portabilidad (Debe ser llamada después de renderizar)
      function attachPortabilityViewListeners() {
        document.querySelectorAll(".view-portability-btn").forEach((button) => {
          button.removeEventListener("click", handlePortabilityViewClick);
          button.addEventListener("click", handlePortabilityViewClick);
        });
      }

      function handlePortabilityViewClick(e) {
        const portId = parseInt(e.currentTarget.dataset.portabilityId);
        const portData = MOCK_PORTABILITY_DATA.registers.find(
          (r) => r.id === portId
        );

        if (portData) {
          openPortabilityDetailsModal(portData);
        } else {
          console.error(
            `No se encontraron datos para la portabilidad con ID: ${portId}`
          );
        }
      }

      // ----------------------------------------------------------------
      // LÓGICA DE LA VISTA DE NÚMEROS (EXISTENTE)
      // ----------------------------------------------------------------

      function clearNumbersFilters() {
        document.getElementById("filterNumber").value = "";
        document.getElementById("filterNumberTenant").value = "";
        document.getElementById("filterStatus").value = "";
        document.getElementById("filterQuarantine").value = "";
        document.getElementById("filterRCID").value = "";
        document.getElementById("filter").value = "";
        currentPageNumbers = 1;
        applyNumbersFilters();
      }

      function applyNumbersFilters() {
        const filters = {
          number: document.getElementById("filterNumber").value.toLowerCase(),
          tenant: document
            .getElementById("filterNumberTenant")
            .value.toLowerCase(),
          status: document.getElementById("filterStatus").value.toLowerCase(),
          quarantine: document
            .getElementById("filterQuarantine")
            .value.toLowerCase(),
          // Nuevo filtro de días
          quarantineDays: document
            .getElementById("filterQuarantineDays")
            .value.toLowerCase(),
          rcid: document.getElementById("filterRCID").value.toLowerCase(),
          porta: document.getElementById("filterPorta").value.toLowerCase(),
        };

        filteredNumbers = MOCK_NUMBERS_VIEW.filter((n) => {
          const numberMatch = n.number.toLowerCase().includes(filters.number);
          const tenantMatch = (n.tenant || "")
            .toLowerCase()
            .includes(filters.tenant);
          const statusMatch =
            filters.status === "" || n.status.toLowerCase() === filters.status;
          const quarantineMatch =
            filters.quarantine === "" ||
            n.quarantine.toLowerCase() === filters.quarantine;

          // Filtro de Días Restantes
          // Solo buscamos si el usuario escribió algo en el filtro.
          // Convertimos el dato a string para poder buscar (ej: si busca "5" encuentra "15" o "5")
          const daysValue = n.dias_cuarentena
            ? n.dias_cuarentena.toString()
            : "";
          const daysMatch =
            filters.quarantineDays === "" ||
            daysValue.includes(filters.quarantineDays);

          const rcidMatch =
            filters.rcid === "" ||
            (n.rcid && n.rcid.toLowerCase().includes(filters.rcid)) ||
            (n.rcid_cuenta &&
              n.rcid_cuenta.toLowerCase().includes(filters.rcid));

          // Lógica de Portabilidad (Previa)
          let portaMatch = true;
          if (filters.porta !== "") {
            if (filters.porta === "propiedad mcm") {
              portaMatch = n.status.toLowerCase() === "disponible";
            } else {
              portaMatch = n.status.toLowerCase() === "asignado";
            }
          }

          return (
            numberMatch &&
            tenantMatch &&
            statusMatch &&
            quarantineMatch &&
            daysMatch && // Agregamos el match de días al retorno
            rcidMatch &&
            portaMatch
          );
        });

        currentPageNumbers = 1;
        renderNumbersTable();
      }

      function renderNumbersTable() {
        const table = document.getElementById("numbersTable");
        table.innerHTML = "";

        pageSizeNumbers = parseInt(
          document.getElementById("numbersPageSize").value,
          10
        );
        const totalPages = Math.ceil(filteredNumbers.length / pageSizeNumbers);

        if (currentPageNumbers > totalPages)
          currentPageNumbers = totalPages || 1;
        if (currentPageNumbers < 1) currentPageNumbers = 1;

        const start = (currentPageNumbers - 1) * pageSizeNumbers;
        const end = start + pageSizeNumbers;
        const pageData = filteredNumbers.slice(start, end);

        if (pageData.length === 0) {
          // Nota: actualizamos colspan a 7 porque agregamos una columna nueva
          table.innerHTML = `<tr><td colspan="7" class="py-10 text-center text-gray-500">No se encontraron números que coincidan con los filtros.</td></tr>`;
        } else {
          pageData.forEach((num, index) => {
            const statusColor =
              num.status === "Disponible"
                ? "bg-green-100 text-mcm-green"
                : "bg-blue-100 text-mcm-blue";

            const quarantineColor =
              num.quarantine === "Si"
                ? "bg-mcm-yellow text-gray-800 font-bold"
                : "bg-gray-100 text-gray-500";

            // --- Lógica Portabilidad ---
            let portaText = "";
            if (num.status === "Disponible") {
              portaText = "Propiedad MCM";
            } else {
              if (index === 2 || num.number.endsWith("9")) {
                portaText = "Baja";
              } else {
                portaText = "Alta";
              }
            }

            // --- Lógica Días Restantes (NUEVA) ---
            let daysText = "-";

            // Si está en cuarentena "Si", mostramos los días.
            // Si el dato 'dias_cuarentena' no existe en tu BD mock, aquí generamos uno aleatorio visualmente
            // para que veas como queda, o ponemos "0" si no hay dato.
            if (num.quarantine === "Si") {
              // Usamos el dato real si existe, sino "N/D" (No Disponible) o un número fake si prefieres probar
              daysText =
                num.dias_cuarentena !== undefined ? num.dias_cuarentena : "5";
            } else {
              // Si no está en cuarentena, forzosamente es guion
              daysText = "-";
            }

            const row = `
                <tr class="hover:bg-gray-50 transition duration-150">
                    <td class="px-6 py-4 text-sm font-mono text-gray-900">${
                      num.number
                    }</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${num.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${quarantineColor}">
                            ${num.quarantine}
                        </span>
                    </td>
                    
                    <td class="px-6 py-4 text-sm text-gray-700 font-bold text-center">
                        ${daysText}
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-700 truncate max-w-xs" title="${
                      num.tenant || ""
                    }">
                        ${num.tenant || "N/A"}
                    </td>
                    <td class="px-6 py-4 text-sm font-mono text-gray-700">
                        ${num.rcid_cuenta || "N/A"}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        ${portaText}
                    </td>
                </tr>
            `;
            table.innerHTML += row;
          });
        }

        // ... (El resto del código de paginación se mantiene igual) ...
        const totalItems = filteredNumbers.length;
        const showingFrom = totalItems > 0 ? start + 1 : 0;
        const showingTo = Math.min(end, totalItems);

        document.getElementById(
          "numbersPageInfo"
        ).textContent = `Mostrando ${showingFrom}-${showingTo} de ${totalItems} resultados (Página ${currentPageNumbers} de ${
          totalPages || 1
        })`;

        document.getElementById("numbersPrevPage").disabled =
          currentPageNumbers === 1;
        document.getElementById("numbersNextPage").disabled =
          currentPageNumbers === totalPages || totalPages === 0;
      }

      // ----------------------------------------------------------------
      // LÓGICA DE LA VISTA DE CUENTAS (EXISTENTE)
      // ----------------------------------------------------------------

      function renderTable() {
        if (!isAuthReady) {
          console.log("Waiting for authentication before rendering table.");
          return;
        }

        const table = document.getElementById("accountsTable");
        table.innerHTML = "";

        // 1. Obtener filtros
        const filters = {
          id: document.getElementById("filterId").value.toLowerCase(),
          tenant: document.getElementById("filterTenant").value.toLowerCase(),
          opp: document.getElementById("filterOpp").value.toLowerCase(),
        };

        // 2. Aplicar filtrado
        filteredAccounts = accounts.filter(
          (a) =>
            a.id.toLowerCase().includes(filters.id) &&
            a.tenant.toLowerCase().includes(filters.tenant) &&
            a.opp.toLowerCase().includes(filters.opp)
        );

        // 3. Obtener tamaño de página actual
        pageSizeAccounts = parseInt(
          document.getElementById("pageSize").value,
          10
        );

        const totalPages = Math.ceil(
          filteredAccounts.length / pageSizeAccounts
        );

        // Ajustar currentPage si está fuera de límites
        if (currentPageAccounts > totalPages)
          currentPageAccounts = totalPages || 1;
        if (currentPageAccounts < 1) currentPageAccounts = 1;

        // 4. Calcular datos de la página
        const start = (currentPageAccounts - 1) * pageSizeAccounts;
        const end = start + pageSizeAccounts;
        const pageData = filteredAccounts.slice(start, end);

        // 5. Renderizar filas
        if (pageData.length === 0) {
          table.innerHTML = `<tr><td colspan="4" class="py-10 text-center text-gray-500">No se encontraron cuentas que coincidan con los filtros.</td></tr>`;
        } else {
          pageData.forEach((acc) => {
            const isMocked = MOCK_ACCOUNTS.find(
              (m) => m.id_ring_central === acc.id
            ); // Para habilitar el botón de vista
            const row = `
							<tr class="hover:bg-gray-50">
								<td class="px-6 py-4 text-sm font-medium text-gray-900">${acc.id}</td>
								<td class="px-6 py-4 text-sm text-gray-900">${acc.tenant}</td>
								<td class="px-6 py-4 text-sm text-gray-900">${acc.opp}</td>

								<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium flex justify-center space-x-2">
									<!-- Botón de Ver Detalles -->
									<button class="action-button bg-mcm-blue hover:bg-blue-700 text-white view-details-btn ${
                    !isMocked ? "opacity-50 cursor-not-allowed" : ""
                  }"
										data-account-id="${acc.id}" ${!isMocked ? "disabled" : ""}>
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
										</svg>
									</button>

									<!-- Botón de Editar -->
									<button class="action-button bg-green-500 hover:bg-green-600 text-white">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-4 4L9 9"/>
										</svg>
									</button>

									<!-- Botón de Eliminar -->
									<button class="action-button bg-red-500 hover:bg-red-600 text-white">
										<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4 a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
										</svg>
									</button>
								</td>
							</tr>
						`;
            table.innerHTML += row;
          });
        }

        // 6. Actualizar paginación
        const totalItems = filteredAccounts.length;
        const showingFrom = totalItems > 0 ? start + 1 : 0;
        const showingTo = Math.min(end, totalItems);

        document.getElementById(
          "pageInfo"
        ).textContent = `Mostrando ${showingFrom}-${showingTo} de ${totalItems} resultados (Página ${currentPageAccounts} de ${
          totalPages || 1
        })`;

        document.getElementById("prevPage").disabled =
          currentPageAccounts === 1;
        document.getElementById("nextPage").disabled =
          currentPageAccounts === totalPages || totalPages === 0;

        // Re-adjuntar listeners de vista (se re-renderizó la tabla)
        attachViewListeners();
      }

      function clearFilters() {
        document.getElementById("filterId").value = "";
        document.getElementById("filterTenant").value = "";
        document.getElementById("filterOpp").value = "";
        currentPageAccounts = 1;
        renderTable();
      }

      // --- Funciones de Utilidad de Modales (Mantenidas) ---
      function showModal(modalElement) {
        modalElement.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
      }

      function hideModal(modalElement) {
        modalElement.classList.add("hidden");
        // Si todos los modales están ocultos, quitamos el overflow-hidden del body
        if (
          accountModal.classList.contains("hidden") &&
          viewDetailsModal.classList.contains("hidden") &&
          licenseManagementModal.classList.contains("hidden") &&
          numberManagementModal.classList.contains("hidden") && // Incluir modal 4
          portabilityModal.classList.contains("hidden") && // Incluir modal 5
          portabilityDetailsModal.classList.contains("hidden") // Incluir modal 6
        ) {
          document.body.classList.remove("overflow-hidden");
        }
      }

      // Función para resetear el modal de Agregar Cuenta
      function resetAddAccountModal() {
        // Limpiar campos de Oportunidad
        document.getElementById("op_id").value = "123456"; // Resetear a valor de prueba

        // Limpiar display DIVs (Datos Cliente/PM)
        const displayDivsToClear = [
          "client_name_display",
          "client_street_display",
          "client_colony_display",
          "client_city_display",
          "client_state_display",
          "client_country_display",
          "client_zip_display",
          "pm_responsible_display",
          "pm_email_display",
        ];
        displayDivsToClear.forEach((id) => {
          const div = document.getElementById(id);
          if (div) {
            div.textContent = "N/A"; // Set default placeholder text
          }
        });

        // Resetear OT y ocultar licenciamiento
        document.getElementById("pm_ot").value = "";
        document.getElementById("licensingSection").classList.add("hidden");
        document.getElementById("licensingTableContainer").innerHTML =
          '<p class="p-4 text-gray-500 text-center">Seleccione una OT para cargar las licencias de la oportunidad.</p>';

        currentLoadedAccount = null;
      }

      // Función para aplicar estilos y datos de Tarjeta de Presentación
      function setClientDataReadOnly(data) {
        // Mapeo de IDs de elementos de visualización (DIVs) a datos
        const displayMap = {
          client_name_display: data.client_name,
          client_street_display: data.client_street,
          client_colony_display: data.client_colony,
          client_city_display: data.client_city,
          client_state_display: data.client_state,
          client_country_display: data.client_country,
          client_zip_display: data.client_zip,
          pm_responsible_display: data.pm_responsible,
          pm_email_display: data.pm_email,
        };

        Object.entries(displayMap).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value || "N/A";
          }
        });

        // El dropdown de OT se mantiene con el valor actual ("Seleccione una OT")
        document.getElementById("licensingSection").classList.add("hidden");
      }

      // Función de mock para buscar la Oportunidad
      function searchOpportunity() {
        const opId = document.getElementById("op_id").value;
        const account = MOCK_ACCOUNTS.find((a) => a.oportunidad_id === opId);
        const pmOtSelect = document.getElementById("pm_ot");

        if (account) {
          // 1. Mostrar mensaje de éxito (o simplemente cargar los datos)
          console.log(
            `Oportunidad ${opId} encontrada. Cargando datos de cliente/PM.`
          );

          // 2. Cargar la data y transformarla a Tarjeta de Presentación
          setClientDataReadOnly(account);

          // 3. Almacenar la data para el manejo posterior de la OT y Guardar
          currentLoadedAccount = account;

          // 4. Mostrar feedback de éxito visible para el usuario
          console.log("Datos de cliente y PM cargados en modo solo lectura.");

          // NOTA: El licenciamiento SÓLO se mostrará cuando el usuario cambie el dropdown de OT.
        } else {
          // 1. Mostrar mensaje de error
          console.error(
            `Oportunidad ${opId} no encontrada. Intente con '123456' o '654321'.`
          );

          // 2. Resetear campos y permitir edición (reseteamos todo a N/A)
          resetAddAccountModal();

          // 3. Mostrar feedback de error visual en el input de OP
          const inputOp = document.getElementById("op_id");
          inputOp.classList.add("border-red-500", "ring-red-500");
          setTimeout(() => {
            inputOp.classList.remove("border-red-500", "ring-red-500");
          }, 2000);
        }
      }

      // ----------------------------------------------------------------
      // Funciones de Generación de Tablas para Modales
      // ----------------------------------------------------------------

      function generateNumbersTableHTML(numbersData, rcId) {
        if (!numbersData || numbersData.length === 0) {
          return '<p class="p-4 text-gray-500 text-center">No hay números telefónicos asignados a esta cuenta.</p>';
        }

        const tableRows = numbersData
          .map((num, index) => {
            // Generar un ID único para el número simulando un ID de RingCentral
            const uniqueRcId = `${rcId.substring(0, 5)}-N${index + 1}`;

            // El color del status ya no se usa, pero mantenemos el color del tipo
            const typeColor =
              num.type === "Main Number"
                ? "bg-mcm-light-blue text-mcm-blue font-bold"
                : "bg-gray-100 text-gray-700 font-medium";

            return `
							<tr class="hover:bg-gray-50">
								<!-- Nueva columna: ID Ring Central (único por número) -->
								<td class="px-4 py-3 text-sm text-gray-900 font-medium">${
                  num.rcid || uniqueRcId
                }</td>
								
								<td class="px-4 py-3 text-sm text-gray-900 font-mono">${num.number}</td>
								<td class="px-4 py-3">
									<span class="px-3 py-1 inline-flex text-xs leading-5 rounded-full ${typeColor}">
										${num.type}
									</span>
								</td>
								<!-- Columna Estatus eliminada -->
							</tr>
						`;
          })
          .join("");

        return `
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-200 text-gray-700">
							<tr>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">ID Ring Central</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Número</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Tipo de Asignación</th>
								<!-- Columna Estatus eliminada -->
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							${tableRows}
						</tbody>
					</table>
				`;
      }

      // Función auxiliar para generar la tabla de licencias (Read-Only)
      function generateLicensingTableHTML(licensingData, isViewModal = false) {
        if (!licensingData || licensingData.length === 0) {
          return '<p class="p-4 text-gray-500 text-center">No hay licencias asignadas.</p>';
        }

        // Usar un color de encabezado diferente si es el modal de agregar (para distinguirlo)
        const headerClass = isViewModal
          ? "bg-gray-200 text-gray-700"
          : "bg-mcm-blue text-white";
        const finalColHeader = isViewModal ? "Asignadas" : "Cant Lic";

        let tableRows = licensingData
          .map(
            (lic) => `
							<tr class="hover:bg-gray-50">
								<td class="px-4 py-3 text-sm text-gray-900">${lic.sku}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.type}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.product}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.package}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.pkg_id}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.lic_id}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.qty}</td>
								<td class="px-4 py-3 text-sm text-gray-900">${lic.subfam}</td>
								<td class="px-4 py-3 text-center">
									<!-- Mostrar cantidad de licencias o un botón de cantidad, dependiendo del modal -->
									<span class="inline-block w-8 h-8 leading-8 rounded-full bg-mcm-light-blue text-mcm-blue text-xs font-bold flex items-center justify-center">${lic.qty}</span>
								</td>
							</tr>
						`
          )
          .join("");

        return `
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="${headerClass}">
							<tr>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">SKU</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Tipo</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Producto</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Paquete</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">PKG ID</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Licencia</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Cant Lic</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Subfam</th>
								<th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">${finalColHeader}</th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							${tableRows}
						</tbody>
					</table>
				`;
      }

      // NUEVA FUNCIÓN: Genera la tabla de licencias en modo editable
      function generateEditableLicensingTableHTML(licensingData) {
        if (!licensingData || licensingData.length === 0) {
          return '<p class="p-4 text-gray-500 text-center">No hay licencias asignadas para editar. Por favor, solicite primero la adición a través del proceso de oportunidad.</p>';
        }

        const tableRows = licensingData
          .map(
            (lic) => `
							<tr class="hover:bg-gray-100" data-lic-id="${lic.id}">
								<td class="px-4 py-3 text-sm font-medium text-gray-900">${lic.sku}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${lic.product}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${lic.type}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${lic.subfam}</td>
								<td class="px-4 py-3 text-sm text-gray-700">${lic.pkg_id}</td>
								<td class="px-4 py-3 text-center w-24">
									<input 
										type="number" 
										min="0" 
										value="${lic.qty}" 
										data-lic-id="${lic.id}"
										class="form-input p-1 text-center w-full shadow-md"
									/>
								</td>
								<td class="px-4 py-3 text-center">
									<button class="text-red-500 hover:text-red-700 transition" data-lic-id="${lic.id}" onclick="removeLicenseRow(this)">
										 	<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
									</button>
								</td>
							</tr>
						`
          )
          .join("");

        return `
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-mcm-blue text-white">
							<tr>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">SKU</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Producto</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Tipo</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Subfam</th>
								<th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">PKG ID</th>
								<th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Cantidad</th>
								<th class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider">Acción</th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							${tableRows}
						</tbody>
					</table>
				`;
      }

      // Función principal para poblar el modal de vista con datos
      function populateViewModal(data) {
        // --- 1. Actualizar Header ---
        document.getElementById("view-header-client-name").textContent =
          data.tenant || "Cuenta Desconocida";
        document.getElementById("view-header-rcid").textContent =
          data.id_ring_central;

        // Almacenar en global para Gestion Licencias
        activeAccountForManagement = data;

        // --- 2. Campos de Cliente/PM (Usando el id para mapear al mock data) ---
        // Oportunidad
        document.getElementById("view-op_id").textContent = data.op_id;

        // Datos Cliente (Dirección)
        document.getElementById("view-client_street").textContent =
          data.client_street;
        document.getElementById("view-client_colony").textContent =
          data.client_colony;
        document.getElementById("view-client_city").textContent =
          data.client_city;
        document.getElementById("view-client_state").textContent =
          data.client_state;
        document.getElementById("view-client_country").textContent =
          data.client_country;
        document.getElementById("view-client_zip").textContent =
          data.client_zip;

        // Datos PM
        document.getElementById("view-pm_ot").textContent = data.pm_ot;
        document.getElementById("view-pm_responsible").textContent =
          data.pm_responsible;
        document.getElementById("view-pm_email").textContent = data.pm_email;

        // --- 3. Generar tabla de Números ---
        const numbersContainer = document.getElementById(
          "view-numbers-table-container"
        );
        // PASAR EL ID DE RING CENTRAL DE LA CUENTA PARA SIMULAR LA GENERACIÓN DE ID ÚNICO
        numbersContainer.innerHTML = generateNumbersTableHTML(
          data.numbers,
          data.id_ring_central
        );

        // --- 4. Generar tabla de Licencias ---
        const licensingContainer = document.getElementById(
          "view-licensing-table-container"
        );
        licensingContainer.innerHTML = generateLicensingTableHTML(
          data.licensing,
          true
        );
      }

      // NUEVA FUNCIÓN: Abre y carga el modal de gestión de licencias
      function openLicenseManagementModal(accountData) {
        const modal = document.getElementById("licenseManagementModal");

        // **ACTUALIZADO**: Usar la estructura de encabezado de Detalles
        document.getElementById(
          "manage-header-client-name"
        ).textContent = `Gestión de Licencias para: ${accountData.tenant}`;
        document.getElementById("manage-header-rcid").textContent =
          accountData.id_ring_central;

        // Cargar tabla editable
        const tableContainer = document.getElementById(
          "manage-licensing-table-container"
        );
        tableContainer.innerHTML = generateEditableLicensingTableHTML(
          accountData.licensing
        );

        showModal(modal);
      }

      // NUEVA FUNCIÓN: Abre y carga el modal de gestión de números
      function openNumberManagementModal(accountData) {
        const modal = document.getElementById("numberManagementModal");

        // 1. Actualizar cabecera
        document.getElementById(
          "number-manage-header-client-name"
        ).textContent = `Gestión de Números para: ${accountData.tenant}`;
        document.getElementById("number-manage-header-rcid").textContent =
          accountData.id_ring_central;

        // 2. Carga automática de listas
        const rcId = accountData.id_ring_central;

        // Cargar números de la cuenta
        accountNumbers = [...accountData.numbers];

        // Cargar números disponibles: Tomar del pool global y excluir los que ya tiene la cuenta.
        const assignedNumbers = new Set(accountNumbers.map((n) => n.number));
        availableDIDs = MOCK_AVAILABLE_DIDS_POOL.filter(
          (n) => !assignedNumbers.has(n.number)
        );

        // 3. Resetear selecciones
        selectedDIDs = []; // Array vacío
        selectedAccountNumbers = []; // Array vacío

        // 4. Renderizar listas
        renderNumberLists();

        // 5. Mostrar modal
        showModal(modal);

        console.log(
          `Números cargados automáticamente para RC ID: ${rcId}. Disponibles: ${availableDIDs.length}, Asignados: ${accountNumbers.length}`
        );
      }

      // ----------------------------------------------------------------
      // Lógica Dual List Box (Gestión de Números)
      // ----------------------------------------------------------------

      /**
       * Helper function to fix the SyntaxError: Invalid or unexpected token.
       * This function encapsulates the complex DOM query logic.
       * @param {HTMLElement} element The clicked DIV/card element.
       */
      window.triggerCheckboxClick = (element) => {
        // Buscar el checkbox que no esté deshabilitado dentro del elemento
        const checkbox = element.querySelector(
          'input[type="checkbox"]:not(:disabled)'
        );
        if (checkbox) {
          // Ejecutar el clic. Esto activará el handler 'onchange'.
          checkbox.click();
        }
      };

      function renderNumberLists(filterText = "") {
        const availableList = document.getElementById("availableDIDsList");
        const accountList = document.getElementById("accountNumbersList");
        const availableCount = document.getElementById("availableCount");
        const accountNumbersCount = document.getElementById(
          "accountNumbersCount"
        );

        // Referencia al botón de Main Number para habilitar/deshabilitar
        const assignMainNumberBtn = document.getElementById(
          "assignMainNumberBtn"
        );

        // Función para renderizar un item de número
        const renderItem = (num, isAccountList) => {
          const numberStr = num.number;

          // Determinar si está seleccionado
          const isSelected = isAccountList
            ? selectedAccountNumbers.includes(numberStr)
            : selectedDIDs.includes(numberStr);

          const isMain = num.type === "Main Number";

          // Checkbox is disabled if it's the Main Number in the account list
          const isCheckboxDisabled = isAccountList && isMain;

          const checkboxHtml = isCheckboxDisabled
            ? `<input type="checkbox" class="h-4 w-4 text-gray-400 rounded cursor-not-allowed" disabled ${
                isSelected ? "checked" : ""
              }>`
            : `<input type="checkbox" data-number="${numberStr}" data-list="${
                isAccountList ? "account" : "available"
              }" class="h-4 w-4 text-mcm-blue rounded border-gray-300 focus:ring-mcm-blue" ${
                isSelected ? "checked" : ""
              } onchange="handleCheckboxChange(this)">`;

          if (
            filterText &&
            !numberStr.toLowerCase().includes(filterText.toLowerCase())
          ) {
            return ""; // Filter
          }

          // Lógica para la etiqueta:
          let labelHtml = "";
          if (isMain) {
            // Show "Main Number" badge next to the number (Requested change)
            labelHtml = `<span class="badge-main-number">Main Number</span>`;
          }
          // For "Inventory" type (and others that are not Main Number), the label is empty.

          return `
						<div 
							class="number-list-item ${isSelected ? "number-list-selected" : ""} ${
            isMain && isAccountList ? "is-main-number" : ""
          }" 
							data-number="${numberStr}"
							data-type="${num.type}"
							onclick="${
                isCheckboxDisabled
                  ? ""
                  : "event.stopPropagation(); triggerCheckboxClick(this);"
              }"
						>
							<!-- 1. CHECKBOX (A la izquierda y centrado verticalmente) -->
							<div class="flex items-center"> 
								${checkboxHtml}
							</div>
							
							<!-- 2. NÚMERO + ETIQUETA (A la derecha, centrado verticalmente) -->
							<div class="flex items-center space-x-2"> 
								<span class="font-mono text-base text-gray-900">${numberStr}</span>
								${labelHtml} 
							</div>
						</div>
					`;
        };

        // --- Renderizar DIDs Disponibles ---
        availableList.innerHTML = availableDIDs
          .map((num) => renderItem(num, false))
          .join("");
        availableCount.textContent = availableDIDs.length;

        // --- Renderizar Números de Cuenta ---
        if (accountNumbers.length === 0) {
          accountList.innerHTML = `
							<div class="p-4 text-gray-500 text-center flex flex-col items-center justify-center h-full">
								<svg xmlns="http://www.w3.org/2ood-0" class="h-10 w-10 text-gray-300 mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-5a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
								<span>Sin números asignados</span>
							</div>`;
        } else {
          accountList.innerHTML = accountNumbers
            .map((num) => renderItem(num, true))
            .join("");
        }
        accountNumbersCount.textContent = accountNumbers.length;

        // Habilitar/Deshabilitar botones de transferencia
        const transferToAccountBtn = document.getElementById(
          "transferToAccountBtn"
        );
        const transferFromAccountBtn = document.getElementById(
          "transferFromAccountBtn"
        );

        // Habilitar si hay DIDs seleccionados
        transferToAccountBtn.disabled = selectedDIDs.length === 0;

        // Habilitar si hay Números de Cuenta seleccionados (y ninguno es Main Number)
        const hasMainSelected = selectedAccountNumbers.some(
          (num) =>
            accountNumbers.find((n) => n.number === num)?.type === "Main Number"
        );
        transferFromAccountBtn.disabled =
          selectedAccountNumbers.length === 0 || hasMainSelected;

        // Habilitar/Deshabilitar Main Number: Habilitar si SOLO hay un número de Inventory seleccionado
        const isSingleInventorySelected =
          selectedAccountNumbers.length === 1 &&
          accountNumbers.find((n) => n.number === selectedAccountNumbers[0])
            ?.type === "Inventory";
        assignMainNumberBtn.disabled = !isSingleInventorySelected;
      }

      // NUEVA FUNCIÓN: Maneja el cambio de estado de un checkbox
      window.handleCheckboxChange = (checkbox) => {
        const number = checkbox.dataset.number;
        const isAccountList = checkbox.dataset.list === "account";
        const isChecked = checkbox.checked;

        const list = isAccountList ? selectedAccountNumbers : selectedDIDs;
        const index = list.indexOf(number);

        if (isChecked) {
          if (index === -1) {
            list.push(number);
          }
        } else {
          if (index > -1) {
            list.splice(index, 1);
          }
        }

        // Forzar re-renderizado para actualizar el estado de los botones de transferencia
        renderNumberLists(document.getElementById("availableDIDsSearch").value);
      };

      // Función para mover un DID disponible a la cuenta (Selección múltiple/individual)
      function transferToAccount() {
        if (selectedDIDs.length === 0) return;

        const rcId = activeAccountForManagement.id_ring_central;

        // Los números a transferir son los que están en selectedDIDs
        selectedDIDs.forEach((number) => {
          const didIndex = availableDIDs.findIndex((n) => n.number === number);
          if (didIndex > -1) {
            const didToMove = availableDIDs[didIndex];
            availableDIDs.splice(didIndex, 1); // Eliminar de disponibles

            // Asignar como Inventory por defecto y agregar a la cuenta
            didToMove.type = "Inventory";
            // MOCK: Generar un nuevo RCID temporal
            didToMove.rcid =
              rcId.substring(0, 5) + "-T" + (accountNumbers.length + 1);
            accountNumbers.push(didToMove);
          }
        });

        const transferCount = selectedDIDs.length;
        selectedDIDs = []; // Limpiar selecciones

        renderNumberLists(document.getElementById("availableDIDsSearch").value);
        console.log(
          `${transferCount} números transferidos a la cuenta como Inventory.`
        );
        document.getElementById("saveNumberChangesBtn").disabled = false;
      }

      // Función para mover un Número de Cuenta a Disponible (Eliminar, Selección múltiple/individual)
      function transferFromAccount() {
        if (selectedAccountNumbers.length === 0) return;

        let numbersToKeep = [];
        let numbersRemoved = [];

        // Filtramos los números de la cuenta: si están en la selección, se eliminan.
        accountNumbers.forEach((number) => {
          const isSelected = selectedAccountNumbers.includes(number.number);

          if (isSelected) {
            // Regla: No se puede eliminar el Main Number (ya validado en renderLists)
            if (number.type === "Main Number") {
              console.error(
                `ERROR: No se puede eliminar el Main Number (${number.number}).`
              );
              numbersToKeep.push(number); // Lo mantenemos
              return;
            }

            // Mover a disponibles (simular liberación)
            if (
              MOCK_AVAILABLE_DIDS_POOL.some((d) => d.id === number.id) ||
              number.rcid?.startsWith(
                activeAccountForManagement.id_ring_central.substring(0, 0) +
                  "-T"
              )
            ) {
              availableDIDs.push({ ...number, type: "Inventory" });
            }
            numbersRemoved.push(number.number);
          } else {
            numbersToKeep.push(number);
          }
        });

        accountNumbers = numbersToKeep;
        selectedAccountNumbers = []; // Limpiar selecciones

        renderNumberLists(document.getElementById("availableDIDsSearch").value);
        console.log(
          `${numbersRemoved.length} números eliminados de la cuenta y liberados.`
        );
        document.getElementById("saveNumberChangesBtn").disabled = false;
      }

      // Función para asignar un número como Main Number
      function assignMainNumber() {
        if (selectedAccountNumbers.length !== 1) return;

        const numberToMakeMain = selectedAccountNumbers[0];

        accountNumbers = accountNumbers.map((n) => {
          // Desasignar Main Number existente
          if (n.type === "Main Number") {
            n.type = "Inventory";
          }
          // Asignar el nuevo Main Number
          if (n.number === numberToMakeMain) {
            n.type = "Main Number";
          }
          return n;
        });

        // Deseleccionar el número después de la acción
        selectedAccountNumbers = [];

        renderNumberLists(document.getElementById("availableDIDsSearch").value);
        console.log(`Número ${numberToMakeMain} asignado como Main Number.`);
        document.getElementById("saveNumberChangesBtn").disabled = false;
      }

      // MOCK: Simulación de la lógica de guardado de licencias
      function handleLicenseSave() {
        const rcId = document.getElementById("manage-header-rcid").textContent;
        const changes = [];

        document
          .querySelectorAll(
            '#manage-licensing-table-container input[type="number"]'
          )
          .forEach((input) => {
            const licId = input.dataset.licId;
            const newQty = parseInt(input.value, 10);
            const oldQty =
              activeAccountForManagement.licensing.find((l) => l.id === licId)
                ?.qty || 0;

            if (newQty !== oldQty) {
              changes.push({
                id: licId,
                oldQty: oldQty,
                newQty: newQty,
                action:
                  newQty > oldQty
                    ? "Aumentar"
                    : newQty < oldQty
                    ? "Disminuir"
                    : "Eliminar",
              });
            }
          });

        if (changes.length > 0) {
          console.log(
            `--- GUARDANDO CAMBIOS DE LICENCIAS PARA CUENTA ${rcId} ---`
          );
          changes.forEach((change) => console.log(change));
          console.log("¡Cambios guardados exitosamente! (MOCK)");
          hideModal(document.getElementById("licenseManagementModal"));
        } else {
          console.log(
            "No se detectaron cambios en las licencias para guardar."
          );
          hideModal(document.getElementById("licenseManagementModal"));
        }
      }

      // MOCK: Simulación de la lógica de guardado de números
      function handleNumberSave() {
        const rcId = document.getElementById(
          "number-manage-header-rcid"
        ).textContent;
        console.log(`--- GUARDANDO CAMBIOS DE NÚMEROS PARA CUENTA ${rcId} ---`);
        console.log("Números Asignados Finales:", accountNumbers);

        // Aquí iría la lógica de persistencia real
        // ...

        console.log("¡Cambios de números guardados exitosamente! (MOCK)");
        document.getElementById("saveNumberChangesBtn").disabled = true; // Deshabilitar después de guardar
        hideModal(document.getElementById("numberManagementModal"));
      }

      // MOCK: Simulación de eliminación de fila (ajusta el DOM temporalmente)
      window.removeLicenseRow = function (buttonElement) {
        const licId = buttonElement.dataset.licId;
        const row = buttonElement.closest("tr");
        if (row) {
          console.log(`Licencia ${licId} marcada para eliminación.`);
          row.remove();
          document.getElementById("saveLicenseChangesBtn").disabled = false; // Habilitar guardar al eliminar
          // Nota: En un entorno real, esto marcaría la licencia para eliminación en la solicitud de guardado.
        }
      };

      // ----------------------------------------------------------------
      // Funciones de Paginación y Eventos
      // ----------------------------------------------------------------

      function attachViewListeners() {
        const viewDetailsBtns = document.querySelectorAll(".view-details-btn");
        viewDetailsBtns.forEach((button) => {
          button.removeEventListener("click", handleViewClick); // Prevenir duplicados
          if (!button.disabled) {
            button.addEventListener("click", handleViewClick);
          }
        });
      }

      function handleViewClick(e) {
        const accountId = e.currentTarget.dataset.accountId;
        const accountData = MOCK_ACCOUNTS.find(
          (a) => a.id_ring_central === accountId
        );

        if (accountData) {
          activeAccountForManagement = accountData; // Cargar la data en el global para los botones de acción
          populateViewModal(accountData);
          showModal(viewDetailsModal);
        } else {
          console.error("No se encontraron datos para la cuenta:", accountId);
        }
      }

      // Handler para el cambio en el select de OT (nueva funcionalidad)
      function handlePmOtChange(e) {
        const selectedOt = e.target.value;
        const licensingSection = document.getElementById("licensingSection");
        const tableContainer = document.getElementById(
          "licensingTableContainer"
        );

        if (selectedOt && currentLoadedAccount) {
          // Simular que la data de licencias se carga solo si la OT es seleccionada Y tenemos data de cuenta
          licensingSection.classList.remove("hidden");
          tableContainer.innerHTML = generateLicensingTableHTML(
            currentLoadedAccount.licensing,
            false
          );
          console.log(`Licenciamiento cargado para OT: ${selectedOt}`);
        } else {
          // Ocultar si no hay selección o si no se ha cargado la data de la oportunidad
          licensingSection.classList.add("hidden");
          tableContainer.innerHTML =
            '<p class="p-4 text-gray-500 text-center">Seleccione una OT para cargar las licencias de la oportunidad.</p>';
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Inicializar Firebase (o usar mock si falla config)
        initFirebase();

        // Referencias principales
        const accountModal = document.getElementById("accountModal");
        const viewDetailsModal = document.getElementById("viewDetailsModal");
        const licenseManagementModal = document.getElementById(
          "licenseManagementModal"
        );
        const numberManagementModal = document.getElementById(
          "numberManagementModal"
        );
        const portabilityModal = document.getElementById("portabilityModal"); // Modal 5
        const portabilityDetailsModal = document.getElementById(
          "portabilityDetailsModal"
        ); // Modal 6

        // Tabs de navegación
        document.querySelectorAll("nav a").forEach((tab) => {
          tab.addEventListener("click", (e) => {
            e.preventDefault();
            const viewId = e.target.dataset.view;
            changeView(viewId);
          });
        });

        // Iniciar la vista por defecto (Cuentas)
        changeView("cuentas");

        // --- Event Listeners de la Vista de Cuentas ---
        const searchOpportunityBtn = document.getElementById(
          "searchOpportunityBtn"
        );
        const pmOtSelect = document.getElementById("pm_ot");
        const openBtn = document.getElementById("openModalBtn");
        const closeBtn = document.getElementById("closeModalBtn");
        const cancelBtn = document.getElementById("cancelModalBtn");
        const closeViewBtn = document.getElementById("closeViewModalBtn");
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");
        const pageSizeSelect = document.getElementById("pageSize");
        const clearFiltersBtn = document.getElementById("clearFiltersBtn");
        const searchFiltersBtn = document.getElementById("searchFiltersBtn");
        const toggleFiltersBtn = document.getElementById("toggleFiltersBtn");
        const filterBar = document.getElementById("filterBar");
        const filterIcon = document.getElementById("filterIcon");

        // Altura para la animación de filtros de CUENTAS
        let originalHeightAccounts = 0;
        let filtersVisibleAccounts = true;

        // Toggle de filtros de CUENTAS
        function toggleAccountsFilters() {
          filtersVisibleAccounts = !filtersVisibleAccounts;
          const bar = filterBar;
          const icon = filterIcon;

          if (filtersVisibleAccounts) {
            bar.classList.remove("hidden", "max-h-0", "p-0", "mb-0");
            bar.classList.add("p-4", "mb-6");
            bar.style.maxHeight = originalHeightAccounts + "px";
            icon.classList.remove("rotate-180");
          } else {
            originalHeightAccounts = bar.scrollHeight;
            bar.style.maxHeight = originalHeightAccounts + "px";
            window.getComputedStyle(bar).maxHeight;
            bar.style.maxHeight = "0";
            icon.classList.add("rotate-180");
            setTimeout(() => {
              bar.classList.add("hidden", "max-h-0");
              bar.classList.remove("p-4", "mb-6");
            }, 300);
          }
        }

        if (filterBar) {
          filterBar.style.transition =
            "max-height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out";
          setTimeout(() => {
            originalHeightAccounts = filterBar.scrollHeight;
            filterBar.style.maxHeight = originalHeightAccounts + "px";
          }, 0);
          toggleFiltersBtn.addEventListener("click", toggleAccountsFilters);
        }

        // LISTENERS DE CUENTAS (existentes)
        searchOpportunityBtn.addEventListener("click", searchOpportunity);
        pmOtSelect.addEventListener("change", handlePmOtChange);
        openBtn.addEventListener("click", () => {
          resetAddAccountModal();
          showModal(accountModal);
        });
        closeBtn.addEventListener("click", () => hideModal(accountModal));
        cancelBtn.addEventListener("click", () => hideModal(accountModal));
        closeViewBtn.addEventListener("click", () =>
          hideModal(viewDetailsModal)
        );
        searchFiltersBtn.addEventListener("click", () => {
          currentPageAccounts = 1;
          renderTable();
        });
        clearFiltersBtn.addEventListener("click", clearFilters);
        pageSizeSelect.addEventListener("change", () => {
          currentPageAccounts = 1;
          renderTable();
        });
        prevPageBtn.onclick = () => {
          if (currentPageAccounts > 1) {
            currentPageAccounts--;
            renderTable();
          }
        };
        nextPageBtn.onclick = () => {
          const totalPages = Math.ceil(
            filteredAccounts.length / pageSizeAccounts
          );
          if (currentPageAccounts < totalPages) {
            currentPageAccounts++;
            renderTable();
          }
        };

        // --- Event Listeners de la Vista de NÚMEROS (CORREGIDOS) ---
        const toggleNumbersFiltersBtn = document.getElementById(
          "toggleNumbersFiltersBtn"
        );
        const numbersFilterBar = document.getElementById("numbersFilterBar");
        const numbersFilterIcon = document.getElementById("numbersFilterIcon");
        const searchNumbersFiltersBtn = document.getElementById(
          "searchNumbersFiltersBtn"
        );
        const clearNumbersFiltersBtn = document.getElementById(
          "clearNumbersFiltersBtn"
        );
        const numbersPageSizeSelect =
          document.getElementById("numbersPageSize");
        const numbersPrevPageBtn = document.getElementById("numbersPrevPage");
        const numbersNextPageBtn = document.getElementById("numbersNextPage");

        // Toggle de filtros de NÚMEROS
        function toggleNumbersFilters() {
          filtersVisibleNumbers = !filtersVisibleNumbers;
          const bar = numbersFilterBar;
          const icon = numbersFilterIcon;

          if (filtersVisibleNumbers) {
            // Antes de expandir, forzar el cálculo de la altura
            bar.style.maxHeight = "none";
            originalHeightNumbers = bar.scrollHeight;
            bar.style.maxHeight = originalHeightNumbers + "px";

            // Asegurar clases visuales
            bar.classList.remove("hidden", "max-h-0");
            bar.classList.add("p-4", "mb-6");
            icon.classList.remove("rotate-180");
          } else {
            // Al ocultar, mantener la lógica existente
            originalHeightNumbers = bar.scrollHeight;
            bar.style.maxHeight = originalHeightNumbers + "px";
            window.getComputedStyle(bar).maxHeight;
            bar.style.maxHeight = "0";
            icon.classList.add("rotate-180");
            setTimeout(() => {
              bar.classList.add("hidden", "max-h-0");
              bar.classList.remove("p-4", "mb-6");
            }, 300);
          }
        }

        if (numbersFilterBar) {
          numbersFilterBar.style.transition =
            "max-height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out";
          toggleNumbersFiltersBtn.addEventListener(
            "click",
            toggleNumbersFilters
          );
        }

        // LISTENERS DE NÚMEROS
        searchNumbersFiltersBtn.addEventListener("click", applyNumbersFilters);
        clearNumbersFiltersBtn.addEventListener("click", clearNumbersFilters);
        numbersPageSizeSelect.addEventListener("change", applyNumbersFilters); // Llama a aplicar filtros para resetear página y renderizar
        numbersPrevPageBtn.onclick = () => {
          if (currentPageNumbers > 1) {
            currentPageNumbers--;
            renderNumbersTable();
          }
        };
        numbersNextPageBtn.onclick = () => {
          const totalPages = Math.ceil(
            filteredNumbers.length / pageSizeNumbers
          );
          if (currentPageNumbers < totalPages) {
            currentPageNumbers++;
            renderNumbersTable();
          }
        };

        // Botón Actualizar Números (MOCK)
        document
          .getElementById("updateNumbersBtn")
          .addEventListener("click", () => {
            console.log("Simulando actualización de números...");
            // NOTE: Using a custom modal instead of alert() for real applications. Using alert() here as a mock fallback.
            alert(
              "La simulación de actualización de números ha terminado. Los datos se mantienen sin cambios (MOCK)."
            );
          });

        // LISTENERS DE GESTIÓN DE LICENCIAS
        const closeLicenseBtn = document.getElementById("closeLicenseModalBtn");
        const cancelLicenseBtn = document.getElementById(
          "cancelLicenseModalBtn"
        );
        const saveLicenseBtn = document.getElementById("saveLicenseChangesBtn");
        const btnGestionLicencias = document.getElementById(
          "btnGestionLicencias"
        );

        closeLicenseBtn.addEventListener("click", () =>
          hideModal(licenseManagementModal)
        );
        cancelLicenseBtn.addEventListener("click", () =>
          hideModal(licenseManagementModal)
        );
        saveLicenseBtn.addEventListener("click", handleLicenseSave);

        btnGestionLicencias.addEventListener("click", () => {
          if (activeAccountForManagement) {
            hideModal(viewDetailsModal);
            openLicenseManagementModal(activeAccountForManagement);
          } else {
            console.error(
              "No hay cuenta seleccionada para la gestión de licencias."
            );
          }
        });

        // LISTENERS DE GESTIÓN DE NÚMEROS (DUAL LIST)
        const closeNumberModalBtn = document.getElementById(
          "closeNumberModalBtn"
        );
        const btnGestionNumeros = document.getElementById("btnGestionNumeros");
        const transferToAccountBtn = document.getElementById(
          "transferToAccountBtn"
        );
        const transferFromAccountBtn = document.getElementById(
          "transferFromAccountBtn"
        );
        const assignMainNumberBtn = document.getElementById(
          "assignMainNumberBtn"
        );
        const saveNumberChangesBtn = document.getElementById(
          "saveNumberChangesBtn"
        );
        const availableDIDsSearch = document.getElementById(
          "availableDIDsSearch"
        );

        closeNumberModalBtn.addEventListener("click", () =>
          hideModal(numberManagementModal)
        );
        btnGestionNumeros.addEventListener("click", () => {
          if (activeAccountForManagement) {
            hideModal(viewDetailsModal);
            openNumberManagementModal(activeAccountForManagement);
          } else {
            console.error(
              "No hay cuenta seleccionada para la gestión de números."
            );
          }
        });
        transferToAccountBtn.addEventListener("click", transferToAccount);
        transferFromAccountBtn.addEventListener("click", transferFromAccount);
        assignMainNumberBtn.addEventListener("click", assignMainNumber);
        saveNumberChangesBtn.addEventListener("click", handleNumberSave);
        availableDIDsSearch.addEventListener("input", (e) => {
          const filter = e.target.value.toLowerCase();
          renderNumberLists(filter);
        });

        // LISTENERS DE NUEVA PORTABILIDAD (NUEVO)
        const openPortabilityBtn = document.getElementById(
          "openPortabilityModalBtn"
        );
        const closePortabilityBtn = document.getElementById(
          "closePortabilityModalBtn"
        );
        const cancelPortabilityBtn = document.getElementById(
          "cancelPortabilityBtn"
        );
        const portabilityForm = document.getElementById("portabilityModalForm");
        const addNumberBtn = document.getElementById("addNumberToListBtn");

        if (openPortabilityBtn)
          openPortabilityBtn.addEventListener("click", openPortabilityModal);
        if (closePortabilityBtn)
          closePortabilityBtn.addEventListener("click", () =>
            hideModal(portabilityModal)
          );
        if (cancelPortabilityBtn)
          cancelPortabilityBtn.addEventListener("click", () =>
            hideModal(portabilityModal)
          );
        if (addNumberBtn)
          addNumberBtn.addEventListener("click", addPortabilityNumber);
        if (portabilityForm)
          portabilityForm.addEventListener("submit", registerPortability);

        // LISTENERS DE DETALLES DE PORTABILIDAD (NUEVO)
        const closePortabilityDetailsBtn = document.getElementById(
          "closePortabilityDetailsBtn"
        );
        const closePortabilityDetailsFooterBtn = document.getElementById(
          "closePortabilityDetailsFooterBtn"
        );

        if (closePortabilityDetailsBtn)
          closePortabilityDetailsBtn.addEventListener("click", () =>
            hideModal(portabilityDetailsModal)
          );
        if (closePortabilityDetailsFooterBtn)
          closePortabilityDetailsFooterBtn.addEventListener("click", () =>
            hideModal(portabilityDetailsModal)
          );

        // --- LISTENERS DE FILTROS Y PAGINACIÓN DE PORTABILIDAD (NUEVOS) ---
        const togglePortabilityFiltersBtn = document.getElementById(
          "togglePortabilityFiltersBtn"
        );
        const portabilityFilterBar = document.getElementById(
          "portabilityFilterBar"
        );
        const portabilityFilterIcon = document.getElementById(
          "portabilityFilterIcon"
        );
        const searchPortabilityFiltersBtn = document.getElementById(
          "searchPortabilityFiltersBtn"
        );
        const clearPortabilityFiltersBtn = document.getElementById(
          "clearPortabilityFiltersBtn"
        );
        const portabilityPageSizeSelect = document.getElementById(
          "portabilityPageSize"
        );
        const portabilityPrevPageBtn = document.getElementById(
          "portabilityPrevPage"
        );
        const portabilityNextPageBtn = document.getElementById(
          "portabilityNextPage"
        );

        // Toggle de filtros de PORTABILIDAD
        function togglePortabilityFilters() {
          filtersVisiblePortability = !filtersVisiblePortability;
          const bar = portabilityFilterBar;
          const icon = portabilityFilterIcon;

          if (filtersVisiblePortability) {
            bar.style.maxHeight = "none";
            originalHeightPortability = bar.scrollHeight;
            bar.style.maxHeight = originalHeightPortability + "px";

            bar.classList.remove("hidden", "max-h-0");
            bar.classList.add("p-4", "mb-6");
            icon.classList.remove("rotate-180");
          } else {
            originalHeightPortability = bar.scrollHeight;
            bar.style.maxHeight = originalHeightPortability + "px";
            window.getComputedStyle(bar).maxHeight;
            bar.style.maxHeight = "0";
            icon.classList.add("rotate-180");
            setTimeout(() => {
              bar.classList.add("hidden", "max-h-0");
              bar.classList.remove("p-4", "mb-6");
            }, 300);
          }
        }

        if (portabilityFilterBar) {
          portabilityFilterBar.style.transition =
            "max-height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out";
          togglePortabilityFiltersBtn.addEventListener(
            "click",
            togglePortabilityFilters
          );

          // Inicializar la altura visible si la barra está abierta por defecto (como en este caso)
          setTimeout(() => {
            portabilityFilterBar.style.maxHeight = "none";
            originalHeightPortability = portabilityFilterBar.scrollHeight;
            portabilityFilterBar.style.maxHeight =
              originalHeightPortability + "px";
          }, 0);
        }

        // LISTENERS DE PORTABILIDAD
        searchPortabilityFiltersBtn.addEventListener(
          "click",
          applyPortabilityFilters
        );
        clearPortabilityFiltersBtn.addEventListener(
          "click",
          clearPortabilityFilters
        );
        portabilityPageSizeSelect.addEventListener(
          "change",
          applyPortabilityFilters
        ); // Llama a aplicar filtros para resetear página y renderizar
        portabilityPrevPageBtn.onclick = () => {
          if (currentPagePortability > 1) {
            currentPagePortability--;
            renderPortabilityTables();
          }
        };
        portabilityNextPageBtn.onclick = () => {
          const totalPages = Math.ceil(
            filteredPortability.length / pageSizePortability
          );
          if (currentPagePortability < totalPages) {
            currentPagePortability++;
            renderPortabilityTables();
          }
        };

        // Cierre al hacer clic fuera del modal (backdrop)
        accountModal.addEventListener("click", (e) => {
          if (e.target === accountModal) hideModal(accountModal);
        });
        viewDetailsModal.addEventListener("click", (e) => {
          if (e.target === viewDetailsModal) hideModal(viewDetailsModal);
        });
        licenseManagementModal.addEventListener("click", (e) => {
          if (e.target === licenseManagementModal)
            hideModal(licenseManagementModal);
        });
        numberManagementModal.addEventListener("click", (e) => {
          if (e.target === numberManagementModal)
            hideModal(numberManagementModal);
        });
        portabilityModal.addEventListener("click", (e) => {
          // Nuevo
          if (e.target === portabilityModal) hideModal(portabilityModal);
        });
        portabilityDetailsModal.addEventListener("click", (e) => {
          // Nuevo
          if (e.target === portabilityDetailsModal)
            hideModal(portabilityDetailsModal);
        });

        // Manejo de teclado global para todos los modales
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            // Prioridad al modal visible más reciente
            if (!portabilityDetailsModal.classList.contains("hidden")) {
              hideModal(portabilityDetailsModal);
            } else if (!portabilityModal.classList.contains("hidden")) {
              hideModal(portabilityModal);
            } else if (!numberManagementModal.classList.contains("hidden")) {
              hideModal(numberManagementModal);
            } else if (!licenseManagementModal.classList.contains("hidden")) {
              hideModal(licenseManagementModal);
            } else if (!accountModal.classList.contains("hidden")) {
              hideModal(accountModal);
            } else if (!viewDetailsModal.classList.contains("hidden")) {
              hideModal(viewDetailsModal);
            }
          }
        });

        // La carga inicial de las tablas se realiza en initFirebase()
      });
    </script>
  </body>
</html>
